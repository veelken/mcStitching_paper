\section{Examples}
\label{sec:examples}

In this Section, we illustrate the formalism developed in Section~\ref{sec:stitching_weights} with concrete examples,
drawn from two different applications: the estimation of Drell-Yan (DY) and $\PW$+jets backgrounds in physics analyses at the LHC
and the estimation of trigger rates for the high-luminosity LHC (HL-LHC) upgrade~\cite{TDR_Phase2_LHC},
scheduled to start operation in 2027.

The DY production of lepton pairs ($\PZggx \to \Plepton\Plepton$) as well as the production of $\PW$ bosons with subsequent decay to a charged lepton and a neutrino ($\PW \to \Plepton\Pnu$)
constitute relevant backgrounds to many physics analyses at the LHC,
for example the analysis of SM Higgs ($\PHiggs$) boson production in the decay modes $\PHiggs \to \Pgt\Pgt$ and $\PHiggs \to \PW\PW$
and the search for $\PHiggs$ boson pair production in the decay modes $\PHiggs\PHiggs \to \Pbottom\Pbottom\Pgt\Pgt$ and 
$\PHiggs\PHiggs \to \Pbottom\Pbottom\PW\PW$~\cite{ATLAS:2014aga,Aad:2015vsa,Aad:2019yxi,Aaboud:2018sfw,CMS-HIG-13-004,CMS-HIG-13-027,CMS-HIG-17-002,CMS-HIG-17-006}.
Simulated samples of $\PW$+jets and DY events have been produced for $\Pp\Pp$ collisions at $\sqrt{s}=13$~\TeV center-of-mass energy
using matrix elements computed at leading order (LO) and at next-to-leading order (NLO) accuracy in perturbative quantum chromodynamics (pQCD)
with the program \MGvATNLO $2.4.2$~\cite{Alwall:2014hca}.
The production of DY events is restricted to the PS region $m_{\Plepton\Plepton} > 50$~\GeV, where $m_{\Plepton\Plepton}$ denotes the mass of the lepton pair.
Parton showering, hadronization, and the underlying event are modelled using the program \PYTHIA $v8.2$~\cite{Sjostrand:2014zea} with the tune \textrm{CP5}~\cite{Sirunyan:2019dfx}.
The matching of matrix elements to parton showers is done using the \textrm{MLM} scheme~\cite{Alwall:2007fs} for the LO samples
and the \textrm{FXFX} scheme~\cite{Frederix:2012ps} for the NLO samples.
The DY and $\PW$+jets samples are normalized using cross sections computed at next-to-next-to leading order (NNLO) accuracy in pQCD,
with electroweak corrections taken into account up to NLO accuracy~\cite{Li:2012wna}.
The product of the DY cross section in the PS region $m_{\Plepton\Plepton} > 50$~\GeV
times the branching fraction for the decay into two charged leptons amounts to $6.11$~nb.
The cross section for $\PW$+jets production times the branching fraction for the decay to charged lepton and neutrino amounts to $61.5$~nb.
We will demonstrate the stitching of these samples based on two observables,
$N_{\jet}$ and $\HT$, defined as, respectively, the number of jets and the scalar sum in $\pT$ of the jets in the event.
The PS region in which we perform the stitching will be either one- or two-dimensional.
We will show that for our formalism
it makes little difference whether the stitching is performed in one dimension or in two:
The regions in PS are enumerated by a single index $i$ in either case,
and in either case the probability $P^{i}$ follows a {\em categorical distribution}.

The task of estimating trigger rates for the upcoming high-luminosity data-taking period of the LHC is chosen as second example to illustrate the stitching procedure.
The ``rate'' of a trigger corresponds to the number of $\Pp\Pp$ collision events passing this trigger per unit of time.

The estimation of trigger rates constitutes an important task for demonstrating the physics potential of the HL-LHC.
The HL-LHC physics program demands a large amount of integrated luminosity to be delivered by the LHC 
to facilitate measurements of rare signal processes,
such as the precise measurement of $\PHiggs$ boson couplings and the study of $\PHiggs$ boson pair production, to be performed by the ATLAS and CMS experiments.
In order to satisfy this demand, the HL-LHC is expected to operate at an instantaneous luminosity of $5$-$7.5 \times 10^{34}$~cm$^{-2}$~s$^{-1}$
at a center-of-mass energy of $\sqrt{s} = 14$~\TeV~\cite{TDR_Phase2_LHC}.
The challenge of developing triggers for the HL-LHC is to design the triggers such that most of the rare signal processes pass the triggers,
while background processes are reduced by many orders of magnitude, in order not to exceed bandwidth limitations on the detector read-out 
and on the rate with which events can be written to permanent storage.

The inelastic $\Pp\Pp$ scattering cross section at $\sqrt{s} = 14$~\TeV amounts to $\approx 80$~mb,
resulting in up to $200$ simultaneous $\Pp\Pp$ interactions per crossing of the proton beams at the nominal HL-LHC instantaneous luminosity~\cite{TDR_Phase2_LHC}.
The vast majority of these interactions are inelastic $\Pp\Pp$ scatterings with low momentum exchange,
which predominantly arise from the exchange of gluons between the colliding protons.
We refer to all such interactions that occur in the same crossing of the proton beams as ``pileup''
and denote the number of these interactions by the symbol $N_{\pileup}$.
In order to estimate the rates of triggers at the HL-LHC,
inclusive MC samples of inelastic $\Pp\Pp$ scattering interactions 
and of inelastic $\Pp\Pp$ scatterings with a higher momentum exchange are produced at LO in pQCD
using the program \PYTHIA $v8.2$.
The transverse momentum exchanged between the scattered protons is denoted by the symbol $\pThat$.
We refer to the inclusive samples of inelastic $\Pp\Pp$ scattering interactions with no selection on $\pThat$ applied during the production of these samples
as ``minimum bias'' samples.
The stitching of the minimum bias samples with samples generated for different ranges in $\pThat$ allows to estimate the trigger rates with lower statistical uncertainties.

The production of the samples proceeds by first simulating one ``hard-scatter'' interaction within a given range in $\pThat$
and then adding a number of $N_{\pileup}$ pileup interactions to the same event.
No selection on $\pThat$ is applied when simulating the pileup interactions.
The distinction between the hard-scatter interaction and the pileup interactions is made for the purpose of MC production.
Of course, the hard-scatter interaction and the pileup interactions are indistinguishable in the data that will be recorded at the HL-LHC.
In the data, the scattering in which the transverse momentum exchanged between the protons equals $\pThat$ may occur in any of the $N_{\pileup}$ simultaneous $\Pp\Pp$ interactions.
This is taken into account in our formalism by enumerating the regions in PS of these $N_{\pileup}$ interactions by a vector $I$ of dimension $N_{\pileup}$.
The $k$-th component of this vector indicates the range in $\pThat$ of the $k$-th $\Pp\Pp$ interaction.
The probability $P^{I} = P^{i_{1},\dots,i_{N_{\pileup}}}$ follows a {\em multinomial distribution} in this case.


\subsection{Estimation of DY and \texorpdfstring{$\PW$}{W}+jets backgrounds}
\label{sec:examples_background_yield}

The examples in this section refer to the modelling of DY and $\PW$+jets backgrounds to physics analyses at the LHC.
We will first discuss the stitching of $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD based on the observable $N_{\jet}$, 
followed by a discussion of the stitching of $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD based on the two observables $N_{\jet}$ and $\HT$,
before we conclude this section with a discussion of stitching $\PZggx \to \Plepton\Plepton$ samples generated at NLO in pQCD based on the multiplicity of jets.
In all three cases, we will assume that an inclusive sample, covering the whole PS, is available.
The probabilities $P^{i}$ and $P_{j}^{i}$ in Eq.~(\ref{eq:weight_incl})
follow a categorial distribution and
are obtained by determining the fraction of events that fall into PS region $i$ in the inclusive sample and in the exclusive samples $j$, respectively~\footnote{
  In case no inclusive sample is available to obtain the probabilities $P^{i}$ and $P_{j}^{i}$,
  one can determine these probabilities from the ratio of cross sections that are computed by the program \MGvATNLO 
  or similar programs such as \POWHEG~\cite{Nason:2004rx,Frixione:2007vw,Alioli:2010xd}, \SHERPA~\cite{Gleisberg:2008ta}, \ALPGEN~\cite{Mangano:2002ea}, or \MCFM~\cite{Campbell:2011bn}.}.

\subsubsection{Stitching of LO \texorpdfstring{$\PW$}{W}+jets samples by \texorpdfstring{$N_{\jet}$}{Njet}}
\label{sec:WJets_vs_Njet}

In this example, an inclusive $\PW \to \Plepton\Pnu$ sample simulated at LO accuracy in pQCD 
is stitched with exclusive samples produced for jet multiplicities of $N_{\jet} = 1$, $2$, $3$, and $4$.
The inclusive sample contains events with jet multiplicities between $0$ and $4$.
We divide the PS by the number of jets and set the index $i$ equal to $N_{\jet}$.
The number of events in each MC sample and the values of the $P^{i}$ and $P_{j}^{i}$ are given in Table~\ref{tab:samples_and_probabilities_WJets_vs_Njet}.
The corresponding stitching weights, computed according to Eq.~(\ref{eq:weight_incl}), are given in Table~\ref{tab:weights_WJets_vs_Njet}.

The weights $w^{i}$ decrease as the number of jets increases, 
reflecting the reduction in statistical uncertainty that is achieved by using the exclusive samples in combination with the inclusive one.

In order to demonstrate that the stitching procedure yields background estimates that are unbiased,
we show distributions in $\pT$ of the ``leading'' and ``subleading'' jet (the jets of, respectively, highest and second-highest $\pT$ in the event),
in the multiplicity of jets and in the observable $\HT$ 
for the inclusive sample and for the sum of inclusive plus exclusive samples in Fig.~\ref{fig:controlPlots_WJets_vs_Njet}.
Jets are reconstructed using the anti-\kt algorithm~\cite{Cacciari:2008gp,Cacciari:2011ma} with a distance parameter of $0.4$,
using all stable particles except neutrinos as input, and are required to satisfy the selection criteria $\pT > 25$~\GeV and $\vert\eta\vert < 5.0$.
The distributions are normalized to an integrated luminosity of $140$~fb$^{-1}$, recorded at $\sqrt{s}=13$~\TeV.
Individual exclusive samples $j$ are distinguished by different colors.

The distributions for the inclusive sample and for the sum of inclusive plus exclusive samples, with the stitching weights applied, are in agreement within the statistical uncertainties.
The exclusive samples reduce the statistical uncertainties in particular in the tails of the distributions,
which are the regions most relevant in searches for new physics.

\begin{table}[h!]
\begin{center}
\def\arraystretch{1.3}
\begin{tabular}{l|c|c|ccccc}
\hline
\multirow{2}{20mm}{Sample} & \multirow{2}{*}{Number of events} & \multirow{2}{*}{Cross section [nb]} & \multicolumn{5}{c}{Probabilities}               \\
                           &                                   &                                     & $P^{0}$ & $P^{1}$ & $P^{2}$ & $P^{3}$ & $P^{4}$ \\
\hline
\hline
Inclusive                  & $3 \times 10^{6}$ & $61.5$ & $0.765$ & $0.153$ & $0.053$ & $0.019$ & $0.010$ \\
\hline
$N_{\jet} = 1$             & $5 \times 10^{5}$ & $9.44$  & $0$     & $1$     & $0$     & $0$     & $0$     \\
$N_{\jet} = 2$             & $3 \times 10^{5}$ & $3.25$  & $0$     & $0$     & $1$     & $0$     & $0$     \\
$N_{\jet} = 3$             & $2 \times 10^{5}$ & $1.15$  & $0$     & $0$     & $0$     & $1$     & $0$     \\
$N_{\jet} = 4$             & $         10^{5}$ & $0.634$ & $0$     & $0$     & $0$     & $0$     & $1$     \\
\hline
\end{tabular}
\end{center}
\caption{
  Number of events in the inclusive and exclusive $\PW \to \Plepton\Pnu$ samples simulated at LO accuracy in pQCD,
  and probabilities $P^{i}$ for the events in the inclusive and exclusive samples to populate the different PS regions $i$,
  defined by the observable $N_{\jet}$.
}
\label{tab:samples_and_probabilities_WJets_vs_Njet}
\end{table}

\begin{table}[h!]
\begin{center}
\begin{tabular}{l|ccccc}
\hline
 & \multicolumn{5}{c}{Phase-space regions} \\
 & $0$ & $1$ & $2$ & $3$ & $4$ \\
\hline
\hline
Weight & $20.5$ & $9.84$ & $7.07$ & $4.47$ & $4.85$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Weights $w^{i}$ for the case that inclusive and exclusive $\PW \to \Plepton\Pnu$ samples simulated at LO accuracy in pQCD
  are normalized to 1 fb${}^{-1}$ of integrated luminosity and stitched based on the observable $N_{\jet}$.
}
\label{tab:weights_WJets_vs_Njet}
\end{table}

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,182)(0,0)
\put(6.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_Njet_lead_stack_wRatio_log.pdf}}}
\put(81.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_Njet_sublead_stack_wRatio_log.pdf}}}
\put(6.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_Njet_njet_stack_wRatio_log.pdf}}}
\put(81.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_Njet_ht_stack_wRatio_log.pdf}}}
\put(43.0, 96.0){\small (a)}
\put(118.0, 96.0){\small (b)}
\put(43.0, 0.0){\small (c)}
\put(118.0, 0.0){\small (d)}
\end{picture}
\end{center}
\caption{
  Distributions in $\pT$ of the (a) leading and (b) subleading jet,
  in (c) the multiplicity of jets and in (d) the observable $\HT$,
  for the case that $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD are stitched based on the observable $N_{\jet}$.
}
\label{fig:controlPlots_WJets_vs_Njet}
\end{figure}


\subsubsection{Stitching of LO \texorpdfstring{$\PW$}{W}+jets samples by \texorpdfstring{$N_{\jet}$}{Njet} and \texorpdfstring{$\HT$}{HT}}
\label{sec:WJets_vs_Njet_and_HT}

This example extends the previous one and demonstrates the stitching procedure based on two observables, $N_{\jet}$ and $\HT$.
The exclusive samples are simulated for jet multiplicities of $N_{\jet} = 1$, $2$, $3$, and $4$ 
and for $\HT$ in the ranges $70$-$100$, $100$-$200$, $200$-$400$, $400$-$600$, $600$-$800$, $800$-$1200$, $1200$-$2500$, and $> 2500$~\GeV up to the kinematic limit.
The inclusive sample contains events with jet multiplicities between $0$ and $4$ and covers the full range in $\HT$.
The number of events in the samples simulated in ranges in $\HT$ are given in Table~\ref{tab:samples_WJets_vs_Njet_and_HT}.
The information for the inclusive sample and for the samples produced in slices of jet multiplicity was given in Table~\ref{tab:samples_and_probabilities_WJets_vs_Njet} already.

The corresponding PS regions $i$, defined in the plane of $N_{\jet}$ versus $\HT$, are shown in Fig.~\ref{fig:regions_WJets_vs_Njet_and_HT}.
In total, the probabilities $P^{i}$ and $P_{j}^{i}$ and the corresponding stitching weights $w^{i}$ are computed for $45$ separate PS regions.
The numerical values of the probabilities are given in Table~\ref{tab:probabilities_WJets_vs_Njet_and_HT}, 
while those of the weights are given in Table~\ref{tab:weights_WJets_vs_Njet_and_HT} in the appendix.

Distributions in $\pT$ of the leading and subleading jet,
in jet multiplicity and in the observable $\HT$ 
for the sum of inclusive plus exclusive samples are compared to the distributions obtained for the inclusive sample in Fig.~\ref{fig:controlPlots_WJets_vs_Njet_and_HT}.
We use the same color for all exclusive samples produced in slices of $N_{\jet}$ and another color for all exclusive samples simulated in ranges in $\HT$,
so that one can better see where each of the two sets of samples contribute most.
Below each distribution, we show the relative statistical uncertainties for four cases,
corresponding to only the inclusive sample being used, the inclusive sample being used in combination with the samples produced in slices of $N_{\jet}$,
the inclusive sample being used in combination with the samples simulated in ranges in $\HT$,
and for the case that all samples given in Tables~\ref{tab:samples_and_probabilities_WJets_vs_Njet} and~\ref{tab:samples_WJets_vs_Njet_and_HT} are used together.
As expected, the samples simulated in ranges in $\HT$ reduce the statistical uncertainties in particular in the tail of the $\HT$ distribution.

Physics analyses that search for new particles of high mass, which decay to high $\pT$ jets, are thus best served by producing MC samples in ranges in $\HT$,
whereas the samples binned in $N_{\jet}$ are particularly well suited when the signal process under study features a large number of low $\pT$ jets.

\begin{table}[h!]
\begin{center}
\def\arraystretch{1.3}
\begin{tabular}{l|c|c}
\hline
Sample                   & Number of events    & Cross section [pb] \\
\hline
\hline
$  70 < \HT <  100$~\GeV &            $10^{6}$ & $1.50\times10^{3}$ \\
$ 100 < \HT <  200$~\GeV &            $10^{6}$ & $1.62\times10^{3}$ \\
$ 200 < \HT <  400$~\GeV & $5   \times 10^{5}$ & $479$ \\
$ 400 < \HT <  600$~\GeV & $2.5 \times 10^{5}$ & $67.4$ \\
$ 600 < \HT <  800$~\GeV &            $10^{5}$ & $15.1$ \\
$ 800 < \HT < 1200$~\GeV &            $10^{5}$ & $6.36$ \\
$1200 < \HT < 2500$~\GeV &            $10^{5}$ & $1.27$ \\
$       \HT > 2500$~\GeV &            $10^{5}$ & $9.41\times10^{-3}$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Number of events in the $\PW \to \Plepton\Pnu$ samples simulated at LO accuracy in pQCD and in ranges in $\HT$.
}
\label{tab:samples_WJets_vs_Njet_and_HT}
\end{table}

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,82)(0,0)
\includegraphics*[height=82mm]{plots/regions_WJets_vs_Njet_and_HT.pdf}
\end{picture}
\end{center}
\caption{
  Definition of the PS regions $i$ in the plane of $N_{\jet}$ versus $\HT$,
  for the case that $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD are stitched based on the observables $N_{\jet}$ and $\HT$.
}
\label{fig:regions_WJets_vs_Njet_and_HT}
\end{figure}

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,182)(0,0)
\put(6.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_lead_stack_wRatio_log.pdf}}}
\put(81.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_sublead_stack_wRatio_log.pdf}}}
\put(6.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_njet_stack_wRatio_log.pdf}}}
\put(81.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_ht_stack_wRatio_log.pdf}}}
\put(43.0, 96.0){\small (a)}
\put(118.0, 96.0){\small (b)}
\put(43.0, 0.0){\small (c)}
\put(118.0, 0.0){\small (d)}
\end{picture}
\end{center}
\caption{
  Distributions in $\pT$ of the (a) leading and (b) subleading jet,
  in (c) the multiplicity of jets and in (d) the observable $\HT$,
  for the case that $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD are stitched based on the observables $N_{\jet}$ and $\HT$.
}
\label{fig:controlPlots_WJets_vs_Njet_and_HT}
\end{figure}


\subsubsection{Stitching of NLO DY samples by \texorpdfstring{$N_{\jet}$}{Njet}}

This example demonstrates the stitching of an inclusive $\PZggx \to \Plepton\Plepton$ sample simulated at NLO accuracy in pQCD
with exclusive samples produced in slices of jet multiplicity.
The latter produced for the case of $0$, $1$, and $2$ jets, using the \MGvATNLO commands:
\begin{center}
\begin{tabular}{ll}
$N_{\jet} = 0$: & \texttt{generate p p > ell+ ell- [QCD]} \\
$N_{\jet} = 1$: & \texttt{generate p p > ell+ ell- j [QCD]} \\
$N_{\jet} = 2$: & \texttt{generate p p > ell+ ell- j j [QCD]} \, ,
\end{tabular}
\end{center}
while the inclusive sample is produced by the commands:
\begin{center}
\begin{tabular}{l}
\texttt{generate p p > ell+ ell- [QCD]} \\
\texttt{add process p p > ell+ ell- j [QCD]} \\
\texttt{add process p p > ell+ ell- j j [QCD]} \, .
\end{tabular}
\end{center}

A complication in computing the stitching weights arises from the fact that the jets, represented by the symbol \texttt{j} in the above commands,
refer to quarks and gluons that are present at the Born level, while the samples are generated at NLO accuracy.
The NLO matrix element (ME) that is used to generate the samples contains three different parts, 
corresponding to the Born-level, virtual corrections, and the emission of a real gluon.
For events produced by the ME for the Born-level and for the virtual corrections,
the multiplicity of jets on the ME level matches the multiplicity of the symbols \texttt{j} in the \MGvATNLO commands,
whereas the ME for real gluon emission adds an extra jet at the ME level with respect to the Born level.

The multiplicity of jets at the ME level is determined by counting the number of quarks and gluons of status $1$ 
that are present in the \textrm{Les Houches Event} (LHE)~\cite{Alwall:2006yp} file produced by \MGvATNLO.
The complication for computing the stitching weights arises from the fact that only the jet multiplicity at the ME level is stored in the LHE file for the inclusive sample.
We address this complication by expressing the probability $P$ that we need for the computation of the stitching weights in Eq.~(\ref{eq:weight_incl})
as function of the number of jets at the ME level and determine this probability in the following way:
For the inclusive sample, we obtain the probability $P(N_{\jet}^{\ME})$ for an event in the inclusive sample
to contain $N_{\jet}^{\ME}$ jets at the ME level 
from the distribution of $N_{\jet}^{\ME}$ in the inclusive sample.
We use the superscript ``$\ME$'' to refer to the jet multiplicity at the ME level
and the superscript ``$\Born$'' to refer to the number of jets that are present at the Born level.
For the exclusive samples, the number of jets present at the Born level matches the multiplicity of the symbols \texttt{j} in the \MGvATNLO commands
used to produce these samples.
We express the probability $P(N_{\jet}^{\ME})$ as the product of two factors: $P(N_{\jet}^{\ME}) = P(N_{\jet}^{\Born}) \times P(N_{\jet}^{\ME} \vert N_{\jet}^{\Born})$.
The first factor, $P(N_{\jet}^{\Born})$, is determined by taking the ratio of cross sections computed by the program \MGvATNLO 
for the samples produced in slices of jet multiplicity and for the inclusive sample.
The second factor, $P(N_{\jet}^{\ME} \vert N_{\jet}^{\Born})$, represents the conditional probability for an event to contain $N_{\jet}^{\ME}$ jets at the ME level,
given that the multiplicity of jets at the Born level is $N_{\jet}^{\Born}$.
It corresponds to the probability for events in the exclusive samples to emit a real gluon.
The probability $P(N_{\jet}^{\ME} \vert N_{\jet}^{\Born})$ is obtained by determining the frequency of distinct $N_{\jet}^{\ME}$ values 
in each of the exclusive samples.
The distributions in $N_{\jet}^{\ME}$ for the inclusive sample and for each of the exclusive samples
are shown in Fig.~\ref{fig:probabilities_DYJets_vs_Njet}.
The figure also compares the distribution in $N_{\jet}^{\ME}$ for the inclusive sample
with the distribution obtained for the sum of inclusive plus exclusive samples with the stitching weights applied.
The agreement between the latter two distributions demonstrates that the aforementioned complication arising from real gluon emission in the NLO samples
is adequately addressed.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,182)(0,0)
\put(6.5, 0.0){\mbox{\includegraphics*[height=82mm]{plots/DY_stack_wRatio.pdf}}}
\put(81.5, 0.0){\mbox{\includegraphics*[height=82mm]{plots/DY_stack1.pdf}}}
\end{picture}
\end{center}
\caption{
  Left: Distribution in $N_{\jet}^{\ME}$ for the inclusive $\PZggx \to \Plepton\Plepton$ sample simulated at NLO accuracy in pQCD
  and for the exclusive samples, produced for the case of $N_{\jet}^{\Born} = 0$, $1$, and $2$.
  Right: Comparison of the distribution in $N_{\jet}^{\ME}$ between the inclusive sample
  and the sum of inclusive plus exclusive samples with the stitching weights applied.
}
\label{fig:probabilities_DYJets_vs_Njet}
\end{figure}

The number of events contained in each MC sample and the cross sections computed by the program \MGvATNLO are given in Table~\ref{tab:samples_DYJets_vs_Njet}.
Numerical values for the probabilities $P(N_{\jet}^{\Born})$ and $P(N_{\jet}^{\ME} \vert N_{\jet}^{\Born})$ 
for the samples produced in slices of jet multiplicity are reported in Table~\ref{tab:probabilities_exclusive_DYJets_vs_Njet}.
The stitching weights $w(N_{\jet}^{\ME})$, computed according to Eq.~(\ref{eq:weight_incl}), are given in Table~\ref{tab:weights_DYJets_vs_Njet}.

\begin{table}[h!]
\begin{center}
\def\arraystretch{1.3}
\begin{tabular}{l|c|c}
\hline
Sample                 & Number of events    & Cross section [nb]$^{1}$ \\
\hline
\hline
Inclusive              & $4 \times 10^{6}$ & $6.08$ \\
\hline
$N_{\jet}^{\Born} = 0$ & $2 \times 10^{6}$ & $4.84$ \\
$N_{\jet}^{\Born} = 1$ & $10^{6}$ & $0.898$ \\
$N_{\jet}^{\Born} = 2$ & $10^{6}$ & $3.36$ \\
\hline
\end{tabular}
\end{center}
$^{1}$ Computed at at NLO accuracy in pQCD using the program \MGvATNLO
\caption{
  Number of events in the inclusive and exclusive $\PZggx \to \Plepton\Plepton$ samples simulated at NLO accuracy in pQCD,
  and cross sections, computed by the program \MGvATNLO, for each sample.
}
\label{tab:samples_DYJets_vs_Njet}
\end{table}

\begin{table}[h!]
\begin{center}
\def\arraystretch{1.3}
\begin{tabular}{l|ccc|cccc}
\hline
\multirow{2}{*}{Sample}    & \multicolumn{3}{c|}{Probability $P(N_{\jet}^{\Born})$} & \multicolumn{4}{c}{Probability $P(N_{\jet}^{\ME})$} \\
                           & $N_{\jet}^{\Born} = 0$ & $= 1$   & $= 2$               & $N_{\jet}^{\ME} = 0$ & $= 1$   & $= 2$               & $= 3$ \\
\hline
\hline
Inclusive                  & $0.797$                & $0.148$ & $5.52\times10^{-2}$ & $0.768$              & $0.183$ & $5.99\times10^{-2}$ & $-1.14\times10^{-2}$ \\
\hline
$N_{\jet}^{\Born} = 0$     & $1$                    & $0$     & $0$                 & $0.867$              & $0.133$ & $0$                 & $0$     \\
$N_{\jet}^{\Born} = 1$     & $0$                    & $1$     & $0$                 & $0$                  & $0.999$ & $9.81\times10^{-4}$ & $0$     \\
$N_{\jet}^{\Born} = 2$     & $0$                    & $0$     & $1$                 & $0$                  & $0$     & $1.15$              & $-1.49$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Probabilities $P(N_{\jet}^{\Born})$ and $P(N_{\jet}^{\ME})$ for the inclusive $\PZggx \to \Plepton\Plepton$ sample produced at NLO accuracy in pQCD 
  and for the corresponding exclusive samples, produced in slices of jet multiplicity.
}
\label{tab:probabilities_exclusive_DYJets_vs_Njet}
\end{table}

\begin{table}[h!]
\centering
\def\arraystretch{1.3}
\begin{tabular}{l|cccc}
\hline
Sample                     & $N_{\jet}^{\ME} = 0$ & $= 1$   & $= 2$   & $= 3$ \\ \hline\hline
Weight $w(N_{\jet}^{\ME})$ & $1.27$               & $1.14$  & $0.732$ & $0.782$ \\
\hline
\end{tabular}
\caption{
  Weights $w(N_{\jet}^{\ME})$ for the case that inclusive and exclusive $\PZggx \to \Plepton\Plepton$ sample simulated at NLO accuracy in pQCD
  are normalized to 1 fb${}^{-1}$ of integrated luminosity and stitched based on the observable $N_{\jet}^{\ME}$.
}
\label{tab:weights_DYJets_vs_Njet}
\end{table}

As before, we compare the distributions in $\pT$ of the leading and subleading jet,
in jet multiplicity and in the observable $\HT$ 
for the inclusive sample to the sum of inclusive plus exclusive samples with the stitching weights applied
to demonstrate that the stitching procedure yields an unbiased background estimate.
The distributions are shown in Fig.~\ref{fig:controlPlots_DYJets_vs_Njet}.
They agree within the statistical uncertainties.
Below each distribution, we again show the relative statistical uncertainties for the cases that only the inclusive sample is used
and for case that the inclusive and exclusive samples are used.
Compared to using only the inclusive sample,
the samples binned in jet multiplicity reduce the statistical uncertainties by a similar degree in the NLO case
as was the case for samples simulated at LO accuracy in pQCD, 
which were shown in Fig.~\ref{fig:controlPlots_WJets_vs_Njet} and in the lower part of Fig.~\ref{fig:controlPlots_WJets_vs_Njet_and_HT}.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,182)(0,0)
\put(6.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/DY_lead_stack_wRatio.pdf}}}
\put(81.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/DY_sublead_stack_wRatio.pdf}}}
\put(6.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/DY_njet_stack_wRatio.pdf}}}
\put(81.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/DY_ht_stack_wRatio.pdf}}}
\put(43.0, 96.0){\small (a)}
\put(118.0, 96.0){\small (b)}
\put(43.0, 0.0){\small (c)}
\put(118.0, 0.0){\small (d)}
%ADD ``RATIO'' PLOT BELOW EACH DISTRIBUTION THAT SHOWS RELATIVE STATISTICAL UNCERTAINTY, 
%DEFINED AS BINERROR/BINCONTENT FOR 3 CASES: 1) INCLUSIVE, 2) STITCHED BY NJET
\end{picture}
\end{center}
\caption{
  Distributions in $\pT$ of the (a) leading and (b) subleading jet,
  in (c) the multiplicity of jets and in (d) the observable $\HT$,
  for the case that $\PZggx \to \Plepton\Plepton$ samples generated at NLO accuracy in pQCD are stitched based on the multiplicity of jets at the ME level.
}
\label{fig:controlPlots_DYJets_vs_Njet}
\end{figure}


\subsection{Estimation of trigger rate}
\label{sec:examples_trigger_rate}

The application of the stitching procedure to the case of estimating trigger rates at the HL-LHC demonstrates the flexibility of our formalism.
As already mentioned in Section~\ref{sec:examples}, the probability $P^{I}$ follows a multinomial distribution in this example, 
reflecting the fact that the hard-scatter interaction is indistinguishable from the pileup.
The hard-scatter interaction as well as the pileup are of the same kind of inelastic $\Pp\Pp$ scatterings,
predominantly arising from the exchange of gluons between the colliding protons,
and solely differ by the transverse momentum $\pThat$ that is exchanged in the scattering.

The ``inclusive'' sample in this example are events containing $N_{\pileup} + 1$ minimum bias interactions,
where for each event the number of pileup interactions, $N_{\pileup}$, is sampled at random from the Poisson probability distribution
\begin{equation}
\Poisson(N_{\pileup} \vert \Nbar) = \frac{\Nbar^{N_{\pileup}} \times e^{-\Nbar}}{N_{\pileup}!}
\label{eq:Poisson}
\end{equation}
with a mean $\Nbar = 200$.
The exclusive samples contain one hard-scatter interaction of transverse momentum within a specified range in $\pThat$ plus $N_{\pileup}$ minimum bias interactions for the pileup,
with the number of pileup interactions that is added to each event is again sampled at random from a Poisson distribution with a mean of $\Nbar = 200$.

We enumerate the ranges in $\pThat$ by the index $i$ and denote the number of $\pThat$ ranges used to produce the exclusive samples by the symbol $k$.
We further use the symbol $n_{i}$ to refer to the number of inelastic $\Pp\Pp$ scatterings,
occurring either in the hard-scatter interaction or in any of the pileup interactions,
that fall into the $i$-th interval in $\pThat$.

The probability $P^{I}$ for an event in the inclusive sample that contains $N_{\pileup}$ pileup interactions
to feature $n_{1}$ inelastic $\Pp\Pp$ scatterings that fall into the first interval in $\pThat$, $n_{2}$ into the second,$\dots$, and $n_{k}$ into the $k$-th 
is given by:
\begin{equation}
P^{I} = \frac{(N_{\pileup} + 1)!}{n_{1}! \times \dots \times n_{k}!} \times p_{1}^{n_{1}} \times \dots \times p_{k}^{n_{k}} \, ,
\label{eq:P_inclusive}
\end{equation}
where the symbols $p_{i}$ correspond to the probability for a single inelastic $\Pp\Pp$ scattering interaction to feature a transverse momentum exchange that falls into the $i$-th interval in $\pThat$.
The $n_{i}$ satisfy the condition $N_{\pileup} + 1 = \sum_{i=1}^{k} \, n_{i}$.

The corresponding probability $P_{j}^{I}$ for an event in the $j$-th exclusive sample that contains $N_{\pileup}$ pileup interactions is given by:
\begin{equation}
P_{j}^{I} = \begin{cases}
\frac{N_{\pileup}!}{n_{1}! \times \dots \times (n_{j} - 1)! \times \dots \times n_{k}!} \times p_{1}^{n_{1}} \times \dots \times p_{j}^{(n_{j} - 1)} \times \dots \times p_{k}^{n_{k}} \, ,
  & \text{if $n_{j} \geq 1$} \\
0 \, , & \text{otherwise} \, .
\end{cases}
\label{eq:P_exclusive}
\end{equation}
The $n_{i}$ again satisfy the condition $N_{\pileup} + 1 = \sum_{i=1}^{k} \, n_{i}$.
The fact that for all events in the $j$-th exclusive sample the transverse momentum $\pThat$ exchanged in the hard-scatter interaction falls into the $j$-th interval in $\pThat$
implies that $N_{\pileup} + 1$ needs to be replaced by $N_{\pileup}$ and $n_{j}$ by $n_{j} - 1$ in Eq.~(\ref{eq:P_exclusive}) compared to Eq.~(\ref{eq:P_inclusive}),
as one of scatterings that fall into the $j$-th interval in $\pThat$ is ``fixed'' and thus not subject to the random fluctuations in $\pThat$ which are modelled by the multinomial distribution.
The ratio of Eq.~(\ref{eq:P_exclusive}) to Eq.~(\ref{eq:P_inclusive}) is given by the expression:
\begin{equation}
\frac{P_{j}^{I}}{P^{I}} = \frac{n_{j}}{(N_{\pileup} + 1) \times p_{j}} \, .
\label{eq:P_ratio}
\end{equation}
The validity of Eq.~(\ref{eq:P_ratio}) includes the case $n_{j} = 0$.

The expression for the stitching weight $w^{I}$ is given by an expression similar to Eq.~(\ref{eq:weight_incl}),
the main difference being that the index $i$ is replaced by the vector $I$,
the probabilities $P^{i}$ and $P_{j}^{i}$ are replaced by the probabilities $P^{I}$ and $P_{j}^{I}$, given by Eqs.~(\ref{eq:P_inclusive}) and~(\ref{eq:P_exclusive}),
and the product of luminosity times cross section, $L \times \sigma_{\incl}$, is replaced by the frequency $F$ of $\Pp\Pp$ collisions 
for the purpose of estimating trigger rates at the HL-LHC:
\begin{equation}
w^{I} = \frac{F}{N_{\incl}} \times \frac{N_{\incl} \times P^{I}}{N_{\incl} \times P^{I} + \sum_{j} \, N_{j} \times P_{j}^{I}} \, .
\label{eq:weight_tmp}
\end{equation}
Dividing both numerator and denominator on the right-hand side of Eq.~(\ref{eq:weight_tmp}) by $P^{I}$ and replacing $P_{j}^{I}/P^{I}$ by Eq.~(\ref{eq:P_ratio}) yields:
\begin{equation}
w^{I} = \frac{F}{N_{\incl} + \sum_{j} \, N_{j} \times \frac{n_{j}}{(N_{\pileup} + 1) \times p_{j}}} \, .
\label{eq:weight_trigger_rate}
\end{equation}
At the HL-LHC, the $\Pp\Pp$ collision frequency $F$ amounts to $28$~MHz~\footnote{
  The beams cross every $25$~ns, but $\Pp\Pp$ collisions occur only in $\approx 70\%$ of those beam crossings~\cite{TDR_Phase2_LHC}.}.
Eq.~(\ref{eq:weight_trigger_rate}) represents the equivalent of Eq.~(\ref{eq:weight_incl}),
tailored to the case of estimating trigger rates instead of estimating background contributions.

The ranges in $\pThat$ used to produce the exclusive samples and the number of events contained in each sample
are given in Table~\ref{tab:samples_trigger_rate}.
The association of the index $i$ to the different ranges in $\pThat$ and the 
corresponding values of the probabilities $p_{i}$ are given in Table~\ref{tab:p_trigger_rate}.
The probabilities $p_{i}$ are computed by taking the ratio of the cross sections computed by the program \PYTHIA
for the case of single inelastic $\Pp\Pp$ scattering interactions with a transverse momentum exchange within the $i$-th interval in $\pThat$
and for the case of single inelastic $\Pp\Pp$ scatterings with no condition imposed on $\pThat$.

\begin{table}[h!]
\begin{center}
\begin{tabular}{l|c}
\hline
Sample                    & Number of events \\
\hline
\hline
Inclusive                 & $8 \times 10^{5}$ \\
\hline
$ 30 < \pThat <  50$~\GeV & $4 \times 10^{5}$ \\
$ 50 < \pThat <  80$~\GeV & $2 \times 10^{5}$ \\
$ 80 < \pThat < 120$~\GeV & $1 \times 10^{5}$ \\
$120 < \pThat < 170$~\GeV & $5 \times 10^{4}$ \\
$170 < \pThat < 300$~\GeV & $5 \times 10^{4}$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Number of events in the inclusive and exclusive samples used to estimate trigger rates at the HL-LHC.
}
\label{tab:samples_trigger_rate}
\end{table}

\begin{table}[h!]
\begin{center}
\begin{tabular}{l|cccccc}
\hline
Range in $\pThat$ [\GeV] & $< 30$ & $30$-$50$ & $50$-$80$ & $80$-$120$ & $120$-$170$ & $170$-$300$ \\
Index $i$           & $0$ & $1$ & $2$ & $3$ & $4$ & $5$ \\
\hline
\hline
Probability $p_{i}$ & $0.998$ & $1.69 \times 10^{-3}$ & $2.54 \times 10^{-4}$ & $3.94 \times 10^{-5}$ & $6.20 \times 10^{-6}$ & $1.73 \times 10^{-6}$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Probabilities $p_{i}$ for a single inelastic $\Pp\Pp$ scattering interactions to feature a transverse momentum exchange 
  within the $i$-th interval in $\pThat$.
}
\label{tab:p_trigger_rate}
\end{table}

We cannot give numerical values of the weights $w^{I}$ for this example,
as $I$ is a high-dimensional vector and besides, the weights vary depending on $N_{\pileup}$.
Instead, we show the variation of the weights $w^{I}$, computed according to Eq.~(\ref{eq:weight_trigger_rate}),
for the inclusive sample and for the samples produced in ranges of $\pThat$ in Fig.~\ref{fig:weight_trigger_rate}.
For comparison, we also show the corresponding weight, given by $w_{\incl} = F/N_{\incl}$,
for the case that only the inclusive sample is used to estimate the trigger rate.
As can be seen in the figure, the usage of the samples produced in ranges of $\pThat$ in combination with the inclusive sample reduces the weights.
The different maxima in the distribution of stitching weights $w^{I}$ correspond to events 
in which the transverse momentum exchanges in the $N_{\pileup}$ simultaneous $\Pp\Pp$ interactions falls into different ranges in $\pThat$.
The weights $w^{I}$ are on average smaller for events that pass than for events that fail the trigger selection,
and the reduction in statistical uncertainties that results from the reduction in weights thus increases once the trigger selection is applied.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\includegraphics*[height=82mm]{plots/makeEvtWeightPlotsForPaper_evtWeight_log.pdf}
\end{center}
\caption{
  Weights $w^{I}$, computed according to Eq.~(\ref{eq:weight_trigger_rate}), 
  for the inclusive sample and for the samples produced in ranges of $\pThat$.
}
\label{fig:weight_trigger_rate}
\end{figure}

The rates expected at the HL-LHC for a single jet trigger and a dijet trigger are shown in Fig.~\ref{fig:trigger_rate}.
The rates are computed as function of the $\pT$ threshold that is applied to the jets. 
In case of the dijet trigger, the same $\pT$ threshold is applied to both jets.
The jets are required to satisfy the conditions $\pT > 25$~\GeV and $\vert\eta\vert < 5.0$.
The rate estimates obtained for the inclusive sample and for the sum of inclusive plus exclusive samples, 
with the stitching weights computed according to Eq.~(\ref{eq:weight_trigger_rate}),
agree within statistical uncertainties, demonstrating that the estimate of the trigger rate obtained from the stitching procedure is unbiased.
The statistical uncertainties on the rate estimates obtained from the inclusive sample are represented by error bars,
while those obtained from the sum of inclusive plus exclusive samples are represented by the green shaded area.
The uncertainties are smaller in case the stitching procedure is used, albeit not by much in this example.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,86)(0,0)
\put(6.5, 4.0){\mbox{\includegraphics*[height=82mm]
  {plots/makeRatePlotsForPaper_SingleJet_absEtaLt5p00_log.pdf}}}
\put(81.5, 4.0){\mbox{\includegraphics*[height=82mm]
  {plots/makeRatePlotsForPaper_DoubleJet_absEtaLt5p00_log.pdf}}}
\put(43.0, 0.0){\small (a)}
\put(118.0, 0.0){\small (b)}
\end{picture}
\end{center}
\caption{
  Rate expected for (a) a single jet trigger and (b) a dijet trigger at the HL-LHC, as function of the $\pT$ threshold that is applied to the jets.
}
\label{fig:trigger_rate}
\end{figure}
