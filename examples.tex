\section{Examples}
\label{sec:examples}

In this Section, we illustrate the formalism developed in Section~\ref{sec:stitching_weights} with concrete examples,
drawn from two different applications: the estimation of Drell-Yan (DY) and $\PW$+jets backgrounds in physics analyses at the LHC
and the estimation of trigger rates for the high-luminosity LHC (HL-LHC) upgrade~\cite{TDR_Phase2_LHC},
scheduled to start operation in 2027.

The DY production of lepton pairs ($\PZggx \to \Plepton\Plepton$) as well as the production of $\PW$ bosons with subsequent decay to a charged lepton and a neutrino ($\PW \to \Plepton\Pnu$)
constitute relevant backgrounds to many physics analyses at the LHC,
for example the analysis of SM Higgs ($\PHiggs$) boson production in the decay modes $\PHiggs \to \Pgt\Pgt$ and $\PHiggs \to \PW\PW$
and the search for $\PHiggs$ boson pair production in the decay modes $\PHiggs\PHiggs \to \Pbottom\Pbottom\Pgt\Pgt$ and 
$\PHiggs\PHiggs \to \Pbottom\Pbottom\PW\PW$~\cite{ATLAS:2014aga,Aad:2015vsa,Aad:2019yxi,Aaboud:2018sfw,CMS-HIG-13-004,CMS-HIG-13-027,CMS-HIG-17-002,CMS-HIG-17-006}.
Simulated samples of $\PW$+jets and DY events have been produced for $\Pp\Pp$ collisions at $\sqrt{s}=13$~\TeV center-of-mass energy
using matrix elements computed at leading order (LO) and at next-to-leading order (NLO) accuracy in perturbative quantum chromodynamics (pQCD)
with the program \MGvATNLO $2.4.2$~\cite{Alwall:2014hca}.
The production of DY events is restricted to the fiducial region $m_{\Plepton\Plepton} > 50$~\GeV, where $m_{\Plepton\Plepton}$ denotes the mass of the lepton pair.
Parton showering, hadronization, and the underlying event are modeled using the program \PYTHIA $v8.2$~\cite{Sjostrand:2014zea} with the tune \textrm{CP5}~\cite{Sirunyan:2019dfx}.
The matching of matrix elements to parton showers is done using the \textrm{MLM} scheme~\cite{Alwall:2007fs} for the LO samples
and the \textrm{FXFX} scheme~\cite{Frederix:2012ps} for the NLO samples.
The DY and $\PW$+jets samples are normalized using cross sections computed at next-to-next-to leading order (NNLO) accuracy in pQCD,
with electroweak corrections taken into account up to NLO accuracy~\cite{Li:2012wna}.
The product of the DY cross section in the PS region $m_{\Plepton\Plepton} > 50$~\GeV
times the branching fraction for the decay into two charged leptons amounts to $6.08$~nb,
while the cross section for $\PW$+jets production times the branching fraction for the decay to charged lepton and neutrino amounts to $61.5$~nb.
We will demonstrate the stitching of these samples based on two observables,
$N_{\jet}$ and $\HT$, defined as, respectively, the number of jets and the scalar sum in $\pT$ of jets in the event.
The PS region in which we perform the stitching will be either one- or two-dimensional.
We will show that for our formalism
it makes little difference whether the stitching is performed in one dimension or in two:
The regions in PS are enumerated by a single index $i$ in either case,
and in either case the probability $P^{i}$ follows a categorical distribution.

The task of estimating trigger rates for the upcoming high-luminosity data-taking period of the LHC is chosen as second example to illustrate the stitching procedure.
The ``rate'' of a trigger corresponds to the number of $\Pp\Pp$ collision events that satisfy the trigger condition per unit of time.
The estimation of trigger rates constitutes an important task for demonstrating the physics potential of the HL-LHC.
The HL-LHC physics program demands a large amount of integrated luminosity to be delivered by the LHC, 
in order to facilitate measurements of rare signal processes,
such as the precise measurement of $\PHiggs$ boson couplings and the study of $\PHiggs$ boson pair production, by the ATLAS and CMS experiments.
In order to satisfy this demand, the HL-LHC is expected to operate at an instantaneous luminosity of $5$-$7.5 \times 10^{34}$~cm$^{-2}$~s$^{-1}$
at a center-of-mass energy of $\sqrt{s} = 14$~\TeV~\cite{TDR_Phase2_LHC}.
The challenge of developing triggers for the HL-LHC is to design the triggers such that rare signal processes pass the triggers with a high efficiency,
while the rate of background processes gets reduced by many orders of magnitude, in order not to exceed bandwidth limitations on the detector read-out 
and on the rate with which events can be written to permanent storage.

The inelastic $\Pp\Pp$ scattering cross section at $\sqrt{s} = 14$~\TeV amounts to $\approx 80$~mb,
resulting in up to $200$ simultaneous $\Pp\Pp$ interactions per crossing of the proton beams at the nominal HL-LHC instantaneous luminosity~\cite{TDR_Phase2_LHC}.
The vast majority of these interactions are inelastic $\Pp\Pp$ scatterings with low momentum exchange,
which predominantly arise from the exchange of gluons between the colliding protons.
We refer to inelastic $\Pp\Pp$ scattering interactions with no further selection applied as ``minimum bias'' events.
In order to estimate the rates of triggers at the HL-LHC,
MC samples of minimum bias events are produced at LO in pQCD using the program \PYTHIA $v8.2$.
The minimum bias samples are complemented by samples of inelastic $\Pp\Pp$ scattering interactions
in which a significant amount of transverse momentum, denoted by the symbol $\pThat$, is exchanged between the scattered protons.
The stitching of the minimum bias samples with samples generated for different ranges in $\pThat$ allows to estimate the trigger rates with lower statistical uncertainties.

The production of MC samples used for estimating trigger rates at the HL-LHC
proceeds by first simulating one ``hard-scatter'' (HS) interaction within a given range in $\pThat$
and then adding a number of additional inelastic $\Pp\Pp$ scattering interactions of the minimum bias kind to the same event.
We refer to these additional inelastic $\Pp\Pp$ scattering interactions as ``pileup'' (PU)
and use the symbol $N_{\pileup}$ to denote the total number of these additional inelastic $\Pp\Pp$ scattering interactions 
that occur in the same crossing of the proton beams as the HS interaction.
No selection on $\pThat$ is applied when simulating the PU interactions.
The distinction between the HS interaction and the PU interactions is artificial and solely made for the purpose of MC production.
In the data that will be recorded at the HL-LHC, the HS interaction and the PU interactions will be indistinguishable.
The scattering in which the transverse momentum exchange between the protons amounts to $\pThat$ may occur in any of the $N_{\pileup} + 1$ simultaneous $\Pp\Pp$ interactions.
Our formalism treats the HS interaction and the $N_{\pileup}$ additional PU interactions on an equal footing.
We enumerate the regions in PS of the HS and of the PU interactions by a vector $I$ of dimension $N_{\pileup} + 1$.
The $k$-th component of this vector indicates the range in $\pThat$ of the $k$-th $\Pp\Pp$ interaction.
The probability $P^{I} = P^{i_{1},\dots,i_{N_{\pileup}+1}}$ follows a multinomial distribution.


\subsection{Estimation of DY and \texorpdfstring{$\PW$}{W}+jets backgrounds}
\label{sec:examples_background_yield}

The examples in this section refer to the modelling of DY and $\PW$+jets backgrounds in the context of physics analyses at the LHC.
We will first discuss the stitching of $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD based on the observable $N_{\jet}$, 
followed by a discussion of the stitching of $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD based on the two observables $N_{\jet}$ and $\HT$,
before we conclude this section with a discussion of stitching $\PZggx \to \Plepton\Plepton$ samples generated at NLO in pQCD based on the multiplicity of jets.
In all three cases, we will assume that an inclusive sample, covering the whole PS, is available.


\subsubsection{Stitching of LO \texorpdfstring{$\PW$}{W}+jets samples by \texorpdfstring{$N_{\jet}$}{Njet}}
\label{sec:WJets_vs_Njet}

In this example, an inclusive $\PW \to \Plepton\Pnu$ sample simulated at LO accuracy in pQCD 
is stitched with exclusive samples produced for jet multiplicities of $N_{\jet} = 1$, $2$, $3$, and $4$.
The inclusive sample contains events with jet multiplicities between $0$ and $4$.
We divide the PS by the number of jets and set the index $i$ equal to $N_{\jet}$.
The number of events in each MC sample and the values of the $P^{i}$ and $P_{j}^{i}$ are given in Table~\ref{tab:samples_and_probabilities_WJets_vs_Njet}.
The probabilities $P^{1}$,$\ldots$,$P^{4}$ are computed by taking the ratio of cross sections 
for the $N_{\jet} = 1$,$\ldots$,$4$ samples with respect to the cross section $\sigma_{\incl}$ of the inclusive sample.
The cross sections used for computing these ratios have been calculated at LO accuracy in pQCD using the program \MGvATNLO
and have been upgraded to NNLO accuracy by scaling all cross sections by the ratio ($k$-factor) of the NNLO to LO inclusive cross sections.
The probability $P^{0}$ is obtained using the relation $P^{0} = 1 - \sum_{i=1}^{4} P^{i}$.
The probabilities $P_{j}^{i}$ for the exclusive samples are $1$ if $i=j$ and $0$ otherwise,
as each of the exclusive samples $j$ covers exactly one of the PS regions $i$.
The corresponding stitching weights, computed according to Eq.~(\ref{eq:weight_incl}), are given in Table~\ref{tab:weights_WJets_vs_Njet}.

Except for the $N_{\jet} = 3$ and $N_{\jet} = 4$ regions,
the weights $w^{i}$ decrease as the number of jets increases, 
reflecting the reduction in statistical uncertainty that is achieved by using the exclusive samples in combination with the inclusive one.
The weights $w^{3}$ and $w^{4}$ for the $N_{\jet} = 3$ and $N_{\jet} = 4$ regions are about the same,
reflecting the fact that the number of events in the $N_{\jet} = 4$ sample is smaller compared to the number of events in the $N_{\jet} = 3$ sample
by about the same factor as the ratio of the corresponding cross sections.

In order to demonstrate that the stitching procedure yields background estimates that are unbiased,
we show distributions in $\pT$ of the ``leading'' and ``subleading'' jet (the jets of, respectively, highest and second-highest $\pT$ in the event),
in the multiplicity of jets and in the observable $\HT$ 
for the inclusive sample and for the sum of inclusive plus exclusive samples in Fig.~\ref{fig:controlPlots_WJets_vs_Njet}.
Jets are reconstructed using the anti-\kt algorithm~\cite{Cacciari:2008gp,Cacciari:2011ma} with a distance parameter of $0.4$,
using all stable particles except neutrinos as input, and are required to satisfy the selection criteria $\pT > 25$~\GeV and $\vert\eta\vert < 5.0$.
The distributions are normalized to an integrated luminosity of $140$~fb$^{-1}$, recorded at $\sqrt{s}=13$~\TeV.
Individual exclusive samples $j$ are distinguished by different colors and fill patterns.

The distributions for the inclusive sample and for the sum of inclusive plus exclusive samples, with the stitching weights applied, are in agreement within the statistical uncertainties.
The exclusive samples reduce the statistical uncertainties in particular in the tails of the distributions,
which are the regions most relevant in searches for new physics.

\begin{table}[h!]
\begin{center}
\def\arraystretch{1.3}
\begin{tabular}{l|c|c|c|ccccc}
\hline
\multirow{2}{20mm}{Sample} & Index & Number    & Cross                    & \multicolumn{5}{c}{Probabilities}               \\
                           & $j$   & of events & section [nb]$^{\dagger}$ & $P^{0}$ & $P^{1}$ & $P^{2}$ & $P^{3}$ & $P^{4}$ \\
\hline
\hline
Inclusive                  & $-$   & $3 \times 10^{6}$ & $61.5$ & $0.765$ & $0.153$ & $0.053$ & $0.019$ & $0.010$ \\
\hline
$N_{\jet} = 1$             & $1$   & $5 \times 10^{5}$ & $9.44$  & $0$     & $1$     & $0$     & $0$     & $0$     \\
$N_{\jet} = 2$             & $2$   & $3 \times 10^{5}$ & $3.25$  & $0$     & $0$     & $1$     & $0$     & $0$     \\
$N_{\jet} = 3$             & $3$   & $2 \times 10^{5}$ & $1.15$  & $0$     & $0$     & $0$     & $1$     & $0$     \\
$N_{\jet} = 4$             & $4$   & $         10^{5}$ & $0.634$ & $0$     & $0$     & $0$     & $0$     & $1$     \\
\hline
\end{tabular}
\end{center}
$^{\dagger}$ Computed at LO accuracy in pQCD, then scaled to NNLO
\caption{
  Number of events in the inclusive and exclusive $\PW \to \Plepton\Pnu$ samples simulated at LO accuracy in pQCD,
  probabilities $P^{i}$ for the events in the inclusive and exclusive samples to populate the different PS regions $i$
  defined by the observable $N_{\jet}$, and corresponding cross sections.
}
\label{tab:samples_and_probabilities_WJets_vs_Njet}
\end{table}

\begin{table}[h!]
\begin{center}
\begin{tabular}{l|ccccc}
\hline
 & \multicolumn{5}{c}{Multiplicity of jets} \\
 & $0$ & $1$ & $2$ & $3$ & $4$ \\
\hline
\hline
Weight & $2870$ & $1380$ & $990$ & $625$ & $678$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Weights $w^{i}$ for the case that the inclusive and exclusive $\PW \to \Plepton\Pnu$ samples 
  given in Table~\ref{tab:samples_and_probabilities_WJets_vs_Njet}, simulated at LO accuracy in pQCD,
  are stitched based on the observable $N_{\jet}$.
  The weights are computed for an integrated luminosity of $140\fbinv$.
}
\label{tab:weights_WJets_vs_Njet}
\end{table}

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,182)(0,0)
\put(6.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_Njet_lead_stack_wRatio_log.pdf}}}
\put(81.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_Njet_sublead_stack_wRatio_log.pdf}}}
\put(6.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_Njet_njet_stack_wRatio_log.pdf}}}
\put(81.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_Njet_ht_stack_wRatio_log.pdf}}}
\put(43.0, 96.0){\small (a)}
\put(118.0, 96.0){\small (b)}
\put(43.0, 0.0){\small (c)}
\put(118.0, 0.0){\small (d)}
\end{picture}
\end{center}
\caption{
  Distributions in $\pT$ of the (a) leading and (b) subleading jet,
  in (c) the multiplicity of jets and in (d) the observable $\HT$,
  for the case that $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD are stitched based on the observable $N_{\jet}$.
  The event yields are computed for an integrated luminosity of $140\fbinv$.
}
\label{fig:controlPlots_WJets_vs_Njet}
\end{figure}


\subsubsection{Stitching of LO \texorpdfstring{$\PW$}{W}+jets samples by \texorpdfstring{$N_{\jet}$}{Njet} and \texorpdfstring{$\HT$}{HT}}
\label{sec:WJets_vs_Njet_and_HT}

This example extends the example given in Section~\ref{sec:WJets_vs_Njet}.
It demonstrates the stitching procedure based on two observables, $N_{\jet}$ and $\HT$.
The exclusive samples are simulated for jet multiplicities of $N_{\jet} = 1$, $2$, $3$, and $4$ 
and for $\HT$ in the ranges $70$-$100$, $100$-$200$, $200$-$400$, $400$-$600$, $600$-$800$, $800$-$1200$, $1200$-$2500$, and $> 2500$~\GeV (up to the kinematic limit).
We refer to the exclusive samples produced in slices of $N_{\jet}$ as the ``$N_{\jet}$-samples''
and to the samples simulated in ranges in $\HT$ as the ``$\HT$-samples''.
The inclusive sample contains events with jet multiplicities between $0$ and $4$ and covers the full range in $\HT$.
The number of events in the $\HT$-samples are given in Table~\ref{tab:samples_WJets_vs_Njet_and_HT}.
The information for the inclusive sample and for the $N_{\jet}$-samples is the same as for the previous example
and is given in Table~\ref{tab:samples_and_probabilities_WJets_vs_Njet}.

The corresponding PS regions $i$, defined in the plane of $N_{\jet}$ versus $\HT$, are shown in Fig.~\ref{fig:regions_WJets_vs_Njet_and_HT}.
In total, the probabilities $P^{i}$ and $P_{j}^{i}$ and the corresponding stitching weights $w^{i}$ are computed for $45$ separate PS regions.

In some of the $45$ PS regions, the probabilities $P^{i}$ are rather low, on the level of $10^{-7}$.
In order to reduce the statistical uncertainties on the probabilities $P^{i}$ and $P_{j}^{i}$ as much as possible,
we compute these probabilities using the following procedure:
For all regions $i$ of PS that are covered only by the inclusive sample, and by none of the $\HT$- or $N_{\jet}$-samples,
we obtain the probability $P^{i}$ by determining the fraction of events in the inclusive sample that fall into PS region $i$.
For PS regions $i$ that are covered by the inclusive sample and by one or more $N_{\jet}$- or $\HT$-samples,
we determine the probabilities $P^{i}$ and $P_{j}^{i}$ by the method of least squares~\cite{Cowan:1998ji}.
When applying the least-squares method, we make the assumption that the following relation holds:
\begin{equation}
\sigma_{\incl} \times P^{i} = \sigma_{k} \times P_{k}^{i} \quad \forall k \,
\label{eq:lambda1}
\end{equation}
except for statistical fluctuations on the $P^{i}$ and $P_{k}^{i}$, which we obtain by determining the fraction of events in the inclusive and exclusive samples that fall into PS region $i$.
The symbol $k$ refers to those $N_{\jet}$- and $\HT$-samples that cover the PS region $i$,
and the symbol $\sigma_{k}$ to the cross sections corresponding to these samples.
We denote the unknown true value of the left-hand-side (and equivalently of the right-hand-side) of Eq.~(\ref{eq:lambda1}) by the symbol $\lambda_{i}$
and use the symbols $\Delta P^{i}$ and $\Delta P_{k}^{i}$ to refer to the deviations that are caused by statistical fluctuations
between the true values of the probabilities $P^{i}$ and $P_{k}^{i}$ and the values that we obtain from the MC samples.
We further use the symbols $\delta P^{i}$ and $\delta P_{j}^{i}$ to denote the expected statistical fluctuations of these probabilities.
According to the least-squares method,
the best estimate for the value of $\lambda_{i}$ is obtained as solution to the equations:
\begin{eqnarray*}
\sigma_{\incl} \times \left( P^{i} + \Delta P^{i} \right) - \lambda_{i} & = & 0 \quad \mbox{and} \\
\sigma_{k} \times \left( P_{k}^{i} + \Delta P_{k}^{i} \right) - \lambda_{i} & = & 0 \quad \forall k \, ,
\end{eqnarray*}
subject to the condition that the sum of residuals
\begin{equation*}
S = \left( \frac{\Delta P^{i}}{\delta P^{i}} \right)^{2} + \sum_{k} \left( \frac{\Delta P_{k}^{i}}{\delta P_{k}^{i}} \right)^{2}
\end{equation*}
attains its minimal value.
The expected statistical fluctuations $\delta P^{i}$ and $\delta P_{j}^{i}$ of the probabilities $P^{i}$ and $P_{k}^{i}$
are given by the standard errors of the Binomial distribution~\cite{Cowan:1998ji}
\begin{equation*}
\delta P^{i} = \sqrt{\frac{P^{i} \times (1 - P^{i})}{N_{\incl}}} \quad \mbox{and} \quad \delta P_{k}^{i} = \sqrt{\frac{P_{k}^{i} \times (1 - P_{k}^{i})}{N_{k}}} \, .
\end{equation*}
The fluctuations decrease proportional to the inverse of the square-root of the number of events in the MC samples.
The solution for $\lambda_{i}$ is given by the expression:
\begin{equation}
\lambda_{i} = \frac{w_{\incl} \times \sigma_{\incl} \times P^{i} + \sum_{k} w_{k} \times \sigma_{k} \times P_{k}^{i}}{w_{\incl} + \sum_{k} w_{k}} \, ,
\label{eq:lambda2}
\end{equation}
from which the probabilities $P^{i} = \lambda_{i}/\sigma_{\incl}$ and $P_{k}^{i} = \lambda_{i}/\sigma_{k}$ follow.
The symbols $w_{\incl}$ and $w_{k}$ are defined as:
\begin{equation*}
w_{\incl} = \frac{1}{\left( \sigma_{\incl} \times \delta P^{i} \right)^{2}} \quad \mbox{and} \quad w_{k} = \frac{1}{\left( \sigma_{k} \times \delta P_{k}^{i} \right)^{2}}
\end{equation*}
and act as weights in the expression on the right-hand-side of Eq.~(\ref{eq:lambda2}),
which has the form of a weighted average.

The numerical values of the probabilities $P^{i}$ and of the weights $w^{i}$ are given in Tables~\ref{tab:probabilities_WJets_vs_Njet_and_HT}
and~\ref{tab:weights_WJets_vs_Njet_and_HT} in the appendix.

Distributions in $\pT$ of the leading and subleading jet,
in the multiplicity of jets, and in the observable $\HT$ 
for the sum of inclusive plus exclusive samples are compared to the distributions obtained for the inclusive sample in Fig.~\ref{fig:controlPlots_WJets_vs_Njet_and_HT}.
We use the same fill pattern for all $N_{\jet}$-samples, another pattern for all $\HT$-samples and a third pattern for the stitched inclusive sample,
so that one can better see where each of the stitched samples contribute the most.
Below each distribution, we show the relative statistical uncertainties for four cases,
corresponding to only the inclusive sample being used,
and for the case that all samples given in Tables~\ref{tab:samples_and_probabilities_WJets_vs_Njet} and~\ref{tab:samples_WJets_vs_Njet_and_HT} are used together.
As expected, the addition of samples simulated in ranges in $\HT$ to the example given in Section~\ref{sec:WJets_vs_Njet}
reduce the statistical uncertainties in particular in the tail of the $\HT$ distribution.

Physics analyses that search for new particles of high mass, which decay to high $\pT$ jets, are thus best served by producing MC samples in ranges in $\HT$,
whereas the samples binned in $N_{\jet}$ are particularly well suited when the signal process under study features a large number of low $\pT$ jets.

\begin{table}[h!]
\begin{center}
\def\arraystretch{1.3}
\begin{tabular}{l|c|c|c}
\hline
\multirow{2}{20mm}{Sample} & Index & Number    & Cross                    \\
                           & $j$   & of events & section [nb]$^{\dagger}$ \\
\hline
\hline
$  70 < \HT <  100$~\GeV   &  $5$  &            $10^{6}$ & $1.50 \times 10^{3}$ \\
$ 100 < \HT <  200$~\GeV   &  $6$  &            $10^{6}$ & $1.62 \times 10^{3}$ \\
$ 200 < \HT <  400$~\GeV   &  $7$  & $5   \times 10^{5}$ & $479$ \\
$ 400 < \HT <  600$~\GeV   &  $8$  & $2.5 \times 10^{5}$ & $67.4$ \\
$ 600 < \HT <  800$~\GeV   &  $9$  &            $10^{5}$ & $15.1$ \\
$ 800 < \HT < 1200$~\GeV   & $10$  &            $10^{5}$ & $6.36$ \\
$1200 < \HT < 2500$~\GeV   & $11$  &            $10^{5}$ & $1.27$ \\
$       \HT > 2500$~\GeV   & $12$  &            $10^{5}$ & $9.41 \times 10^{-3}$ \\
\hline
\end{tabular}
\end{center}
$^{\dagger}$ Computed at LO accuracy in pQCD, then scaled to NNLO
\caption{
  Number of events in the $\PW \to \Plepton\Pnu$ samples simulated at LO accuracy in pQCD and in ranges in $\HT$, and corresponding cross sections.
}
\label{tab:samples_WJets_vs_Njet_and_HT}
\end{table}

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,82)(0,0)
\includegraphics*[height=82mm]{plots/regions_WJets_vs_Njet_and_HT.pdf}
\end{picture}
\end{center}
\caption{
  Definition of the PS regions $i$ in the plane of $N_{\jet}$ versus $\HT$,
  for the case that $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD are stitched based on the observables $N_{\jet}$ and $\HT$.
}
\label{fig:regions_WJets_vs_Njet_and_HT}
\end{figure}

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,182)(0,0)
\put(6.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_lead_stack_wRatio_log.pdf}}}
\put(81.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_sublead_stack_wRatio_log.pdf}}}
\put(6.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_njet_stack_wRatio_log.pdf}}}
\put(81.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/WJets_ht_stack_wRatio_log.pdf}}}
\put(43.0, 96.0){\small (a)}
\put(118.0, 96.0){\small (b)}
\put(43.0, 0.0){\small (c)}
\put(118.0, 0.0){\small (d)}
\end{picture}
\end{center}
\caption{
  Distributions in $\pT$ of the (a) leading and (b) subleading jet,
  in (c) the multiplicity of jets and in (d) the observable $\HT$,
  for the case that $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD are stitched based on the observables $N_{\jet}$ and $\HT$.
  The event yields are computed for an integrated luminosity of $140\fbinv$.
}
\label{fig:controlPlots_WJets_vs_Njet_and_HT}
\end{figure}


\subsubsection{Stitching of NLO DY samples by \texorpdfstring{$N_{\jet}$}{Njet}}

This example demonstrates the stitching of an inclusive $\PZggx \to \Plepton\Plepton$ sample simulated at NLO accuracy in pQCD
with exclusive samples produced in slices of jet multiplicity.
The latter are produced for the case of $0$, $1$, and $2$ jets, using the \MGvATNLO commands:
\begin{center}
\begin{tabular}{ll}
$N_{\jet} = 0$: & \texttt{generate p p > ell+ ell- [QCD]} \\
$N_{\jet} = 1$: & \texttt{generate p p > ell+ ell- j [QCD]} \\
$N_{\jet} = 2$: & \texttt{generate p p > ell+ ell- j j [QCD]} \, ,
\end{tabular}
\end{center}
while the inclusive sample is produced by the commands:
\begin{center}
\begin{tabular}{l}
\texttt{generate p p > ell+ ell- [QCD]} \\
\texttt{add process p p > ell+ ell- j [QCD]} \\
\texttt{add process p p > ell+ ell- j j [QCD]} \, .
\end{tabular}
\end{center}

A complication in computing the stitching weights arises from the fact that the jets, represented by the symbol \texttt{j} in the above commands,
refer to quarks and gluons that are present at the Born level, while the samples are generated at NLO accuracy.
The NLO matrix element (ME) that is used to generate the samples contains three different parts, 
corresponding, respectively, to the Born-level, virtual corrections, and the emission of a real gluon.
For events produced by the ME for the Born-level and for the virtual corrections,
the multiplicity of jets on the ME level matches the multiplicity of the symbols \texttt{j} in the above \MGvATNLO commands,
whereas the ME for real gluon emission adds an extra jet at the ME level with respect to the Born level.

We determine the number of jets present at the ME level in a given event by counting the quarks and gluons of status $1$ 
that we find in the \textrm{Les Houches Event} (LHE)~\cite{Alwall:2006yp} file produced by \MGvATNLO.
The complication for computing the stitching weights for the NLO DY samples arises from the fact that only the jet multiplicity at the ME level is stored in the LHE file for the inclusive sample.
We address this complication by determining the probability $P$ that we need for computing the stitching weights according to Eq.~(\ref{eq:weight_incl})
as function of the number of ME-level jets that we find in the LHE file.
Thus, the symbol $i$ that we use to enumerate the different regions in PS
corresponds to the number of jets that are present at the ME level.
We obtain the probabilities $P^{i}$ for the inclusive sample as well as the probabilities $P_{j}^{i}$ for each of the exclusive samples
by plotting the distribution in the number of ME-level jets in the respective sample.
We use the symbols $N_{\jet}^{\ME}$ and $N_{\jet}^{\Born}$ to refer to the number of jets that are present in a given event
at the ME level and at the Born level, respectively.

The number of events contained in each MC sample and the corresponding cross sections are given in Table~\ref{tab:samples_DYJets_vs_Njet}.
The cross sections have been computed at NLO accuracy in pQCD using the program \MGvATNLO
and have been upgraded to NNLO accuracy by scaling them by the ratio of the NNLO to NLO inclusive cross sections.
Numerical values for the probabilities $P^{i}$ and $P_{j}^{i}$ are given in Table~\ref{tab:probabilities_exclusive_DYJets_vs_Njet}.
The stitching weights $w^{i}$, computed according to Eq.~(\ref{eq:weight_incl}), are reported in Table~\ref{tab:weights_DYJets_vs_Njet}.

\begin{table}[h!]
\begin{center}
\def\arraystretch{1.3}
\begin{tabular}{l|c|c|c}
\hline
\multirow{2}{20mm}{Sample} & Index & Number    & Cross                    \\
                           & $j$   & of events & section [nb]$^{\dagger}$ \\
\hline
\hline
Inclusive                  & $-$   & $4 \times 10^{6}$ & $6.08$ \\
\hline
$N_{\jet}^{\Born} = 0$     & $0$   & $2 \times 10^{6}$ & $4.84$ \\
$N_{\jet}^{\Born} = 1$     & $1$   & $10^{6}$ & $0.898$ \\
$N_{\jet}^{\Born} = 2$     & $2$   & $10^{6}$ & $0.336$ \\
\hline
\end{tabular}
\end{center}
$^{\dagger}$ Computed at NLO accuracy in pQCD using the program \MGvATNLO, then scaled to NNLO
\caption{
  Number of events in the inclusive and exclusive $\PZggx \to \Plepton\Plepton$ samples simulated at NLO accuracy in pQCD,
  and cross sections, computed by the program \MGvATNLO, for each sample.
}
\label{tab:samples_DYJets_vs_Njet}
\end{table}

\begin{table}[h!]
\begin{center}
\def\arraystretch{1.3}
\begin{tabular}{l|cccc}
\hline
\multirow{2}{*}{Sample}    & \multicolumn{4}{c}{Probabilities} \\
                           & $P^{0}$ & $P^{1}$ & $P^{2}$ & $P^{3}$ \\
\hline
\hline
Inclusive                  & $0.768$              & $0.183$ & $5.99\times10^{-2}$ & $-1.14\times10^{-2}$ \\
\hline
$N_{\jet}^{\Born} = 0$     & $0.867$              & $0.133$ & $0$                 & $0$     \\
$N_{\jet}^{\Born} = 1$     & $0$                  & $0.999$ & $9.81\times10^{-4}$ & $0$     \\
$N_{\jet}^{\Born} = 2$     & $0$                  & $0$     & $1.15$              & $-0.15$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Probabilities $P^{i}$ and $P_{j}^{i}$ for the inclusive $\PZggx \to \Plepton\Plepton$ sample produced at NLO accuracy in pQCD 
  and for the corresponding exclusive samples, produced in slices of jet multiplicity,
  to contain $N_{\jet}^{\ME} = i$ jets at the ME level.
}
\label{tab:probabilities_exclusive_DYJets_vs_Njet}
\end{table}

\begin{table}[h!]
\centering
\def\arraystretch{1.3}
\begin{tabular}{l|cccc}
\hline
 & \multicolumn{4}{c}{Multiplicity of ME-level jets} \\
 & $0$ & $1$ & $2$ & $3$ \\
\hline
\hline
Weight & $1.27$               & $1.14$  & $0.732$ & $0.782$ \\
\hline
\end{tabular}
\caption{
  Weights $w^{i}$ for the case that the inclusive and exclusive $\PZggx \to \Plepton\Plepton$ samples 
  given in Table~\ref{tab:samples_DYJets_vs_Njet}, simulated at NLO accuracy in pQCD,
  are stitched based on the observable $N_{\jet}^{\ME}$.
  The weights are computed for an integrated luminosity of $140\fbinv$.
}
\label{tab:weights_DYJets_vs_Njet}
\end{table}

As we have done for the previous examples, we again compare the distributions in $\pT$ of the leading and subleading jet,
in jet multiplicity and in the observable $\HT$ 
for the inclusive sample to the sum of inclusive plus exclusive samples with the stitching weights applied
to demonstrate that the stitching procedure yields an unbiased background estimate.
The distributions  obtained for the $\PZggx \to \Plepton\Plepton$ samples simulated at NLO accuracy in pQCD are shown in Fig.~\ref{fig:controlPlots_DYJets_vs_Njet}.
The distributions agree within the statistical uncertainties.
The figure also shows exclusive samples, distinguished with different fill patterns, stacked together before they are stitched with the inclusive sample.
Below each distribution, we again show the relative statistical uncertainties for the cases that only the inclusive sample is used
and for case that the inclusive and exclusive samples are used.
Compared to using only the inclusive sample,
the samples binned in jet multiplicity reduce the statistical uncertainties by a similar degree 
for the $\PZggx \to \Plepton\Plepton$ samples simulated at NLO accuracy in pQCD 
as was the case for the $\PW \to \Plepton\Pnu$ samples generated at LO accuracy in pQCD,
shown in Figs.~\ref{fig:controlPlots_WJets_vs_Njet} and~\ref{fig:controlPlots_WJets_vs_Njet_and_HT}.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,182)(0,0)
\put(6.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/DY_lead_stack_wRatio.pdf}}}
\put(81.5, 100.0){\mbox{\includegraphics*[height=82mm]{plots/DY_sublead_stack_wRatio.pdf}}}
\put(6.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/DY_njet_stack_wRatio.pdf}}}
\put(81.5, 4.0){\mbox{\includegraphics*[height=82mm]{plots/DY_ht_stack_wRatio.pdf}}}
\put(43.0, 96.0){\small (a)}
\put(118.0, 96.0){\small (b)}
\put(43.0, 0.0){\small (c)}
\put(118.0, 0.0){\small (d)}
%ADD ``RATIO'' PLOT BELOW EACH DISTRIBUTION THAT SHOWS RELATIVE STATISTICAL UNCERTAINTY, 
%DEFINED AS BINERROR/BINCONTENT FOR 3 CASES: 1) INCLUSIVE, 2) STITCHED BY NJET
\end{picture}
\end{center}
\caption{
  Distributions in $\pT$ of the (a) leading and (b) subleading jet,
  in (c) the multiplicity of jets and in (d) the observable $\HT$,
  for the case that $\PZggx \to \Plepton\Plepton$ samples generated at NLO accuracy in pQCD are stitched based on the multiplicity of jets at the ME level.
  The event yields are computed for an integrated luminosity of $140\fbinv$.
}
\label{fig:controlPlots_DYJets_vs_Njet}
\end{figure}


\subsection{Estimation of trigger rate}
\label{sec:examples_trigger_rate}

The application of the stitching procedure to the case of estimating trigger rates at the HL-LHC demonstrates the flexibility of our formalism.
As mentioned in Section~\ref{sec:examples}, the probability $P^{I} = P^{i_{1},\dots,i_{N_{\pileup}+1}}$ follows a multinomial distribution in this example.
The symbol $N_{\pileup}$ denotes the number of pileup (PU) interactions 
that occur in the same crossing of the proton beams as the hard-scatter (HS) interaction. 
The distinction between the HS interaction and the PU is artificial and is solely made for the purpose of MC production:
The HS interaction as well as the PU are of the same kind of inelastic $\Pp\Pp$ scatterings,
predominantly arising from the exchange of gluons between the colliding protons,
and solely differ by the transverse momentum $\pThat$ that is exchanged in the scattering.

The ``inclusive'' sample in this example are events containing $N_{\pileup} + 1$ minimum bias interactions,
where for each event the number of PU interactions, $N_{\pileup}$, is sampled at random from the Poisson probability distribution:
\begin{equation}
\Poisson(N_{\pileup} \vert \Nbar) = \frac{\Nbar^{N_{\pileup}} \times e^{-\Nbar}}{N_{\pileup}!}
\label{eq:Poisson}
\end{equation}
with a mean $\Nbar = 200$.
The exclusive samples contain one HS interaction of transverse momentum within a specified range in $\pThat$ and $N_{\pileup}$ additional minimum bias interactions to simulate the PU.
The number $N_{\pileup}$ of PU interactions is again sampled at random from a Poisson distribution with a mean of $\Nbar = 200$.

We enumerate the ranges in $\pThat$ by the index $i$ and denote the number of $\pThat$ ranges used to produce the exclusive samples by the symbol $k$.
We further use the symbol $n_{i}$ to refer to the number of inelastic $\Pp\Pp$ scatterings,
occurring either in the HS interaction or in any of the $N_{\pileup}$ PU interactions,
which fall into the $i$-th interval in $\pThat$.

The probability $P^{I}$ for an event in the inclusive sample that contains $N_{\pileup}$ pileup interactions
to feature $n_{1}$ inelastic $\Pp\Pp$ scatterings that fall into the first interval in $\pThat$, $n_{2}$ into the second,$\dots$, and $n_{k}$ into the $k$-th 
is given by:
\begin{equation}
P^{I} = \frac{(N_{\pileup} + 1)!}{n_{1}! \times \dots \times n_{k}!} \times p_{1}^{n_{1}} \times \dots \times p_{k}^{n_{k}} \, ,
\label{eq:P_inclusive}
\end{equation}
where the symbols $p_{i}$ correspond to the probability for a single inelastic $\Pp\Pp$ scattering interaction to feature a transverse momentum exchange that falls into the $i$-th interval in $\pThat$.
The $n_{i}$ satisfy the condition $\sum_{i=1}^{k} \, n_{i} = N_{\pileup} + 1$.

The corresponding probability $P_{j}^{I}$ for an event in the $j$-th exclusive sample that contains $N_{\pileup}$ pileup interactions is given by:
\begin{equation}
P_{j}^{I} = \begin{cases}
\frac{N_{\pileup}!}{n_{1}! \times \dots \times (n_{j} - 1)! \times \dots \times n_{k}!} \times p_{1}^{n_{1}} \times \dots \times p_{j}^{(n_{j} - 1)} \times \dots \times p_{k}^{n_{k}} \, ,
  & \text{if $n_{j} \geq 1$} \\
0 \, , & \text{otherwise} \, .
\end{cases}
\label{eq:P_exclusive}
\end{equation}
The $n_{i}$ again satisfy the condition $N_{\pileup} + 1 = \sum_{i=1}^{k} \, n_{i}$.
The fact that for all events in the $j$-th exclusive sample the transverse momentum $\pThat$ exchanged in the HS interaction falls into the $j$-th interval in $\pThat$
implies that $N_{\pileup} + 1$ needs to be replaced by $N_{\pileup}$ and $n_{j}$ by $n_{j} - 1$ in Eq.~(\ref{eq:P_exclusive}) compared to Eq.~(\ref{eq:P_inclusive}),
as one of the inelastic $\Pp\Pp$ scatterings that fall into the $j$-th interval in $\pThat$ is ``fixed'' and thus not subject to the random fluctuations, which are modeled by the multinomial distribution.
The ratio of Eq.~(\ref{eq:P_exclusive}) to Eq.~(\ref{eq:P_inclusive}) is given by the expression:
\begin{equation}
\frac{P_{j}^{I}}{P^{I}} = \frac{n_{j}}{(N_{\pileup} + 1) \times p_{j}} \, .
\label{eq:P_ratio}
\end{equation}
The validity of Eq.~(\ref{eq:P_ratio}) includes the case $n_{j} = 0$.

The expression for the stitching weight $w^{I}$ is given by an expression similar to Eq.~(\ref{eq:weight_incl}),
the main difference being that the index $i$ is replaced by the vector $I$,
the probabilities $P^{i}$ and $P_{j}^{i}$ are replaced by the probabilities $P^{I}$ and $P_{j}^{I}$
and the product of luminosity times cross section, $L \times \sigma_{\incl}$, is replaced by the frequency $F$ of $\Pp\Pp$ collisions 
for the purpose of estimating trigger rates at the HL-LHC:
\begin{equation}
w^{I} = \frac{F}{N_{\incl}} \times \frac{N_{\incl} \times P^{I}}{N_{\incl} \times P^{I} + \sum_{j} \, N_{j} \times P_{j}^{I}} \, .
\label{eq:weight_tmp}
\end{equation}
The probabilities $P^{I}$ and $P_{j}^{I}$ are given by Eqs.(~\ref{eq:P_inclusive}) and~(\ref{eq:P_exclusive}).
Dividing both numerator and denominator on the right-hand side of Eq.~(\ref{eq:weight_tmp}) by $P^{I}$ and replacing the ratio $P_{j}^{I}/P^{I}$ by Eq.~(\ref{eq:P_ratio}) yields:
\begin{equation}
w^{I} = \frac{F}{N_{\incl} + \sum_{j} \, N_{j} \times \frac{n_{j}}{(N_{\pileup} + 1) \times p_{j}}} \, .
\label{eq:weight_trigger_rate}
\end{equation}
At the HL-LHC, the $\Pp\Pp$ collision frequency $F$ amounts to $28$~MHz~\footnote{
  The beams cross every $25$~ns, but $\Pp\Pp$ collisions occur only in $\approx 70\%$ of those beam crossings~\cite{TDR_Phase2_LHC}.}.
Eq.~(\ref{eq:weight_trigger_rate}) represents the equivalent of Eq.~(\ref{eq:weight_incl}),
tailored to the case of estimating trigger rates instead of estimating event yields of background processes.

The ranges in $\pThat$ used to produce the exclusive samples and the number of events contained in each sample
are given in Table~\ref{tab:samples_trigger_rate}.
The association of the index $i$ to the different ranges in $\pThat$ and the 
corresponding values of the probabilities $p_{i}$ are given in Table~\ref{tab:p_trigger_rate}.
The probabilities $p_{i}$ are computed by taking the ratio of cross sections computed by the program \PYTHIA
for the case of single inelastic $\Pp\Pp$ scattering interactions with a transverse momentum exchange that is within the $i$-th interval in $\pThat$
and for the case that no condition is imposed on $\pThat$.

\begin{table}[h!]
\begin{center}
\begin{tabular}{l|c}
\hline
Sample                    & Number of events \\
\hline
\hline
Inclusive                 & $8 \times 10^{5}$ \\
\hline
$ 30 < \pThat <  50$~\GeV & $4 \times 10^{5}$ \\
$ 50 < \pThat <  80$~\GeV & $2 \times 10^{5}$ \\
$ 80 < \pThat < 120$~\GeV & $1 \times 10^{5}$ \\
$120 < \pThat < 170$~\GeV & $5 \times 10^{4}$ \\
$170 < \pThat < 300$~\GeV & $5 \times 10^{4}$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Number of events in the inclusive and exclusive samples used to estimate trigger rates at the HL-LHC.
}
\label{tab:samples_trigger_rate}
\end{table}

\begin{table}[h!]
\begin{center}
\small
\begin{tabular}{l|cccccc}
\hline
Range in $\pThat$ [\GeV] & $< 30$ & $30$-$50$ & $50$-$80$ & $80$-$120$ & $120$-$170$ & $170$-$300$ \\
Index $i$           & $0$ & $1$ & $2$ & $3$ & $4$ & $5$ \\
\hline
\hline
Probability $p_{i}$ & $0.998$ & $1.69 \times 10^{-3}$ & $2.54 \times 10^{-4}$ & $3.94 \times 10^{-5}$ & $6.20 \times 10^{-6}$ & $1.73 \times 10^{-6}$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Probabilities $p_{i}$ for a single inelastic $\Pp\Pp$ scattering interaction to feature a transverse momentum exchange 
  between the protons that is within the $i$-th interval in $\pThat$.
}
\label{tab:p_trigger_rate}
\end{table}

We cannot give numerical values of the weights $w^{I}$ for this example,
as $I$ is a high-dimensional vector, and also because the weights $w^{I}$ vary depending on $N_{\pileup}$.
Instead, we show in Fig.~\ref{fig:weight_trigger_rate} the spectrum of the weights $w^{I}$
that we obtain when inserting the numbers given in Tables~\ref{tab:samples_trigger_rate} and~\ref{tab:p_trigger_rate} into Eq.~(\ref{eq:weight_trigger_rate}).
For comparison, we also show the corresponding weight, given by $w_{\incl} = F/N_{\incl}$,
for the case that only the inclusive sample is used to estimate the trigger rate.
As can be seen in Fig.~\ref{fig:weight_trigger_rate}, the addition of samples produced in ranges in $\pThat$ to the inclusive sample reduces the weights.
The different maxima in the distribution of stitching weights $w^{I}$ correspond to events 
in which the transverse momentum exchanged between the scattered protons falls into different ranges in $\pThat$.
The weights $w^{I}$ are on average smaller for events that pass than for events that fail the trigger selection,
as the probability for an event to pass the trigger increases with $\pThat$,
and the reduction in statistical uncertainties that results from the reduction in weights thus increases once the trigger selection is applied.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\includegraphics*[height=76mm]{plots/makeEvtWeightPlotsForPaper_evtWeight_log.pdf}
\end{center}
\caption{
  Weights $w^{I}$, computed according to Eq.~(\ref{eq:weight_trigger_rate}), 
  for the inclusive sample and for the samples produced in ranges of $\pThat$.
}
\label{fig:weight_trigger_rate}
\end{figure}

The rates expected for a single jet trigger and for a dijet trigger at the HL-LHC are shown in Fig.~\ref{fig:trigger_rate}.
The rates are computed as function of the $\pT$ threshold that is applied to the jets. 
In case of the dijet trigger, the same $\pT$ threshold is applied to both jets.
The jets are required to be within the geometric acceptance $\vert\eta\vert < 5.0$.
The rate estimates obtained for the inclusive sample and for the sum of inclusive plus exclusive samples, 
with the stitching weights computed according to Eq.~(\ref{eq:weight_trigger_rate}),
agree within statistical uncertainties, demonstrating that the estimate of the trigger rate obtained from the stitching procedure is unbiased.
The statistical uncertainties on the rate estimates obtained from the inclusive sample are represented by error bars,
while those obtained from the sum of inclusive plus exclusive samples are represented by the shaded area.
The uncertainties are smaller in case the stitching procedure is used, albeit not by much in this example.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,86)(0,0)
\put(4.5, 4.0){\mbox{\includegraphics*[height=86mm]
  {plots/makeRatePlotsForPaper_SingleJet_absEtaLt5p00_log.pdf}}}
\put(83.5, 4.0){\mbox{\includegraphics*[height=86mm]
  {plots/makeRatePlotsForPaper_DoubleJet_absEtaLt5p00_log.pdf}}}
\put(43.0, 0.0){\small (a)}
\put(122.0, 0.0){\small (b)}
\end{picture}
\end{center}
\caption{
  Rate expected for (a) a single jet trigger and (b) a dijet trigger at the HL-LHC, as function of the $\pT$ threshold that is applied to the jets.
}
\label{fig:trigger_rate}
\end{figure}
