\subsection{Estimation of trigger rate}
\label{sec:examples_trigger_rate}

The application of the stitching procedure to the case of estimating trigger rates at the HL-LHC demonstrates the flexibility of our formalism.
As mentioned in Section~\ref{sec:examples}, the probability $P^{I} = P^{i_{1},\dots,i_{N_{\pileup}+1}}$ follows a multinomial distribution in this example.
The symbol $N_{\pileup}$ denotes the number of pileup (PU) interactions 
that occur in the same crossing of the proton beams as the hard-scatter (HS) interaction. 
The distinction between the HS interaction and the PU is artificial and is solely made for the purpose of MC production:
The HS interaction as well as the PU are of the same kind of inelastic $\Pp\Pp$ scatterings,
predominantly arising from the exchange of gluons between the colliding protons,
and solely differ by the transverse momentum $\pThat$ that is exchanged in the scattering.

The ``inclusive'' sample in this example are events containing $N_{\pileup} + 1$ minimum bias interactions,
where for each event the number of PU interactions, $N_{\pileup}$, is sampled at random from the Poisson probability distribution:
\begin{equation}
\Poisson(N_{\pileup} \vert \Nbar) = \frac{\Nbar^{N_{\pileup}} \times e^{-\Nbar}}{N_{\pileup}!}
\label{eq:Poisson}
\end{equation}
with a mean $\Nbar = 200$.
The exclusive samples contain one HS interaction of transverse momentum within a specified range in $\pThat$ and $N_{\pileup}$ additional minimum bias interactions to simulate the PU.
The number $N_{\pileup}$ of PU interactions is again sampled at random from a Poisson distribution with a mean of $\Nbar = 200$.

We enumerate the ranges in $\pThat$ by the index $i$ and denote the number of $\pThat$ ranges used to produce the exclusive samples by the symbol $k$.
We further use the symbol $n_{i}$ to refer to the number of inelastic $\Pp\Pp$ scatterings,
occurring either in the HS interaction or in any of the $N_{\pileup}$ PU interactions,
which fall into the $i$-th interval in $\pThat$.

The probability $P^{I}$ for an event in the inclusive sample that contains $N_{\pileup}$ pileup interactions
to feature $n_{1}$ inelastic $\Pp\Pp$ scatterings that fall into the first interval in $\pThat$, $n_{2}$ into the second,$\dots$, and $n_{k}$ into the $k$-th 
is given by:
\begin{equation}
P^{I} = \frac{(N_{\pileup} + 1)!}{n_{1}! \times \dots \times n_{k}!} \times p_{1}^{n_{1}} \times \dots \times p_{k}^{n_{k}} \, ,
\label{eq:P_inclusive}
\end{equation}
where the symbols $p_{i}$ correspond to the probability for a single inelastic $\Pp\Pp$ scattering interaction to feature a transverse momentum exchange that falls into the $i$-th interval in $\pThat$.
The $n_{i}$ satisfy the condition $\sum_{i=1}^{k} \, n_{i} = N_{\pileup} + 1$.

The corresponding probability $P_{j}^{I}$ for an event in the $j$-th exclusive sample that contains $N_{\pileup}$ pileup interactions is given by:
\begin{equation}
P_{j}^{I} = \begin{cases}
\frac{N_{\pileup}!}{n_{1}! \times \dots \times (n_{j} - 1)! \times \dots \times n_{k}!} \times p_{1}^{n_{1}} \times \dots \times p_{j}^{(n_{j} - 1)} \times \dots \times p_{k}^{n_{k}} \, ,
  & \text{if $n_{j} \geq 1$} \\
0 \, , & \text{otherwise} \, .
\end{cases}
\label{eq:P_exclusive}
\end{equation}
The $n_{i}$ again satisfy the condition $N_{\pileup} + 1 = \sum_{i=1}^{k} \, n_{i}$.
The fact that for all events in the $j$-th exclusive sample the transverse momentum $\pThat$ exchanged in the HS interaction falls into the $j$-th interval in $\pThat$
implies that $N_{\pileup} + 1$ needs to be replaced by $N_{\pileup}$ and $n_{j}$ by $n_{j} - 1$ in Eq.~(\ref{eq:P_exclusive}) compared to Eq.~(\ref{eq:P_inclusive}),
as one of the inelastic $\Pp\Pp$ scatterings that fall into the $j$-th interval in $\pThat$ is ``fixed'' and thus not subject to the random fluctuations, which are modeled by the multinomial distribution.
The ratio of Eq.~(\ref{eq:P_exclusive}) to Eq.~(\ref{eq:P_inclusive}) is given by the expression:
\begin{equation}
\frac{P_{j}^{I}}{P^{I}} = \frac{n_{j}}{(N_{\pileup} + 1) \times p_{j}} \, .
\label{eq:P_ratio}
\end{equation}
The validity of Eq.~(\ref{eq:P_ratio}) includes the case $n_{j} = 0$.

The expression for the stitching weight $w^{I}$ is given by an expression similar to Eq.~(\ref{eq:weight_incl}),
the main difference being that the index $i$ is replaced by the vector $I$,
the probabilities $P^{i}$ and $P_{j}^{i}$ are replaced by the probabilities $P^{I}$ and $P_{j}^{I}$
and the product of luminosity times cross section, $L \times \sigma_{\incl}$, is replaced by the frequency $F$ of $\Pp\Pp$ collisions 
for the purpose of estimating trigger rates at the HL-LHC:
\begin{equation}
w^{I} = \frac{F}{N_{\incl}} \times \frac{N_{\incl} \times P^{I}}{N_{\incl} \times P^{I} + \sum_{j} \, N_{j} \times P_{j}^{I}} \, .
\label{eq:weight_tmp}
\end{equation}
The probabilities $P^{I}$ and $P_{j}^{I}$ are given by Eqs.(~\ref{eq:P_inclusive}) and~(\ref{eq:P_exclusive}).
Dividing both numerator and denominator on the right-hand side of Eq.~(\ref{eq:weight_tmp}) by $P^{I}$ and replacing the ratio $P_{j}^{I}/P^{I}$ by Eq.~(\ref{eq:P_ratio}) yields:
\begin{equation}
w^{I} = \frac{F}{N_{\incl} + \sum_{j} \, N_{j} \times \frac{n_{j}}{(N_{\pileup} + 1) \times p_{j}}} \, .
\label{eq:weight_trigger_rate}
\end{equation}
At the HL-LHC, the $\Pp\Pp$ collision frequency $F$ amounts to $28$~MHz~\footnote{
  The beams cross every $25$~ns, but $\Pp\Pp$ collisions occur only in $\approx 70\%$ of those beam crossings~\cite{TDR_Phase2_LHC}.}.
Eq.~(\ref{eq:weight_trigger_rate}) represents the equivalent of Eq.~(\ref{eq:weight_incl}),
tailored to the case of estimating trigger rates instead of estimating event yields of background processes.

The ranges in $\pThat$ used to produce the exclusive samples and the number of events contained in each sample
are given in Table~\ref{tab:samples_trigger_rate}.
The association of the index $i$ to the different ranges in $\pThat$ and the 
corresponding values of the probabilities $p_{i}$ are given in Table~\ref{tab:p_trigger_rate}.
The probabilities $p_{i}$ are computed by taking the ratio of cross sections computed by the program \PYTHIA
for the case of single inelastic $\Pp\Pp$ scattering interactions with a transverse momentum exchange that is within the $i$-th interval in $\pThat$
and for the case that no condition is imposed on $\pThat$.

\begin{table}[h!]
\begin{center}
\begin{tabular}{l|c}
\hline
Sample                    & Number of events \\
\hline
\hline
Inclusive                 & $8 \times 10^{5}$ \\
\hline
$ 30 < \pThat <  50$~\GeV & $4 \times 10^{5}$ \\
$ 50 < \pThat <  80$~\GeV & $2 \times 10^{5}$ \\
$ 80 < \pThat < 120$~\GeV & $1 \times 10^{5}$ \\
$120 < \pThat < 170$~\GeV & $5 \times 10^{4}$ \\
$170 < \pThat < 300$~\GeV & $5 \times 10^{4}$ \\
$300 < \pThat < 470$~\GeV & $5 \times 10^{4}$ \\
$470 < \pThat < 600$~\GeV & $5 \times 10^{4}$ \\
$\pThat > 600$~\GeV       & $5 \times 10^{4}$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Number of events in the inclusive and exclusive samples used to estimate trigger rates at the HL-LHC.
}
\label{tab:samples_trigger_rate}
\end{table}

\begin{table}[h!]
\begin{center}
\small
\begin{tabular}{l|cccccc}
\hline
Range in $\pThat$ [\GeV] & $< 30$ & $30$-$50$ & $50$-$80$ & $80$-$120$ & $120$-$170$ & $170$-$300$ \\
Index $i$           & $0$ & $1$ & $2$ & $3$ & $4$ & $5$ \\
\hline
\hline
Probability $p_{i}$ & $0.998$ & $1.51 \times 10^{-3}$ & $2.25 \times 10^{-4}$ & $3.38 \times 10^{-5}$ & $6.00 \times 10^{-6}$ & $1.55 \times 10^{-6}$ \\
\hline
\end{tabular}
\begin{tabular}{l|ccc}
\hline
Range in $\pThat$ [\GeV] & $300$-$470$ & $470$-$600$ & $> 600$ \\
Index $i$           & $6$ & $7$ & $8$ \\
\hline
\hline
Probability $p_{i}$ & $1.05 \times 10^{-7}$ & $8.73 \times 10^{-9}$ & $3.12 \times 10^{-9}$ \\
\hline
\end{tabular}
\end{center}
\caption{
  Probabilities $p_{i}$ for a single inelastic $\Pp\Pp$ scattering interaction to feature a transverse momentum exchange 
  between the protons that is within the $i$-th interval in $\pThat$.
}
\label{tab:p_trigger_rate}
\end{table}

We cannot give numerical values of the weights $w^{I}$ for this example,
as $I$ is a high-dimensional vector, and also because the weights $w^{I}$ vary depending on $N_{\pileup}$.
Instead, we show in Fig.~\ref{fig:weight_trigger_rate} the spectrum of the weights $w^{I}$
that we obtain when inserting the numbers given in Tables~\ref{tab:samples_trigger_rate} and~\ref{tab:p_trigger_rate} into Eq.~(\ref{eq:weight_trigger_rate}).
For comparison, we also show the corresponding weight, given by $w_{\incl} = F/N_{\incl}$,
for the case that only the inclusive sample is used to estimate the trigger rate.
The weight $w_{\incl}$ amounts to $35$~Hz in this example.
As can be seen in Fig.~\ref{fig:weight_trigger_rate}, the addition of samples produced in ranges in $\pThat$ to the inclusive sample reduces the weights.
The different maxima in the distribution of stitching weights $w^{I}$ correspond to events 
in which the transverse momentum exchanged between the scattered protons falls into different ranges in $\pThat$.
The spectrum of weights shown in Fig.~\ref{fig:weight_trigger_rate} is plotted before any trigger selection is applied.
The stitching weights $w^{I}$ are on average smaller for events that pass than for events that fail the trigger selection,
as the probability for an event to pass the trigger increases with $\pThat$.
In contrast, the weights $w_{\incl}$ are the same before and after the trigger selection is applied.
The reduction in weights thus becomes more pronounced after the trigger selection is applied.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\includegraphics*[height=76mm]{plots/makeEvtWeightPlotsForPaper_evtWeight_log.pdf}
\end{center}
\caption{
  Weights $w^{I}$, computed according to Eq.~(\ref{eq:weight_trigger_rate}), 
  for the inclusive sample and for the samples produced in ranges of $\pThat$.
}
\label{fig:weight_trigger_rate}
\end{figure}

The rates expected for a single jet trigger and for a dijet trigger at the HL-LHC are shown in Fig.~\ref{fig:trigger_rate}.
The rates are computed as function of the $\pT$ threshold that is applied to the jets. 
In case of the dijet trigger, the same $\pT$ threshold is applied to both jets.
The jets are required to be within the geometric acceptance $\vert\eta\vert < 5.0$.
The rate estimates obtained for the inclusive sample and for the sum of inclusive plus exclusive samples, 
with the stitching weights computed according to Eq.~(\ref{eq:weight_trigger_rate}),
agree within statistical uncertainties, demonstrating that the estimate of the trigger rate obtained from the stitching procedure is unbiased.
The statistical uncertainties on the rate estimates obtained from the inclusive sample are represented by error bars,
while those obtained from the sum of inclusive plus exclusive samples are represented by the shaded area.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(180,86)(0,0)
\put(4.5, 4.0){\mbox{\includegraphics*[height=86mm]
  {plots/makeRatePlotsForPaper_SingleJet_absEtaLt5p00_log.pdf}}}
\put(83.5, 4.0){\mbox{\includegraphics*[height=86mm]
  {plots/makeRatePlotsForPaper_DoubleJet_absEtaLt5p00_log.pdf}}}
\put(43.0, 0.0){\small (a)}
\put(122.0, 0.0){\small (b)}
\end{picture}
\end{center}
\caption{
  Rate expected for (a) a single jet trigger and (b) a dijet trigger at the HL-LHC, as function of the $\pT$ threshold that is applied to the jets.
}
\label{fig:trigger_rate}
\end{figure}

The statistical uncertainties obtained with the stitching procedure are smaller than the ones obtained in case only the inclusive sample is used.
The reduction in the statistical uncertainties is more pronounced for the dijet trigger than for the single jet trigger.
The single jet trigger rate decreases only modestly for jet $\pT$ thresholds greater than $400$~\GeV.
This ``flattening'' of the trigger rate is due to events with low $\pThat$ that contain a single jet of high $\pT$.
The stitching weights $w^{I}$ for these low $\pThat$ events are not much smaller than the weights for the inclusive sample,
which explains why the statistical uncertainties on the single jet trigger rate are reduced only modestly by the stitching procedure.
Thr requirement of a second high $\pT$ jet removes most of these $\pThat$ events.
Consequently, very few low $\pThat$ events pass high jet $\pT$ thresholds in case of the dijet trigger,
with the effect that the dijet trigger rate decreases more rapidly as function of the jet $\pT$ threshold
and the stitching procedure becomes more effective in reducing the statistical uncertainties on the trigger rate.
